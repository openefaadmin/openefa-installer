{% extends "base.html" %}

{% block title %}Quarantine Digest Notifications - OpenEFA{% endblock %}

{% block content %}
<style nonce="{{ csp_nonce }}">
    .hidden { display: none; }
</style>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-bell"></i> Quarantine Digest Notifications
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Receive periodic email digests listing your quarantined emails.
                        Quickly review and release emails without logging into the web interface.
                    </p>

                    <form id="notificationForm">
                        <!-- Enable/Disable -->
                        <div class="form-group mb-4">
                            <div class="custom-control custom-switch custom-control-lg">
                                <input type="checkbox" class="custom-control-input" id="enabledSwitch"
                                       {% if preferences.enabled %}checked{% endif %}>
                                <label class="custom-control-label" for="enabledSwitch">
                                    <strong>Enable Quarantine Email Digests</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Receive periodic emails summarizing your quarantined messages
                            </small>
                        </div>

                        <div id="settingsPanel" class="{% if not preferences.enabled %}hidden{% endif %}">
                            <!-- Frequency -->
                            <div class="form-group">
                                <label for="frequencySelect"><strong>Frequency</strong></label>
                                <select class="form-control" id="frequencySelect">
                                    <option value="daily" {% if preferences.frequency == 'daily' %}selected{% endif %}>Daily</option>
                                    <option value="weekly" {% if preferences.frequency == 'weekly' %}selected{% endif %}>Weekly</option>
                                </select>
                                <small class="form-text text-muted">
                                    How often you want to receive digest emails
                                </small>
                            </div>

                            <!-- Delivery Time -->
                            <div class="form-group">
                                <label for="deliveryTimeSelect"><strong>Delivery Time</strong></label>
                                <select class="form-control" id="deliveryTimeSelect">
                                    <option value="06:00:00" {% if preferences.delivery_time == '06:00:00' %}selected{% endif %}>6:00 AM ✓</option>
                                    <option value="08:00:00" {% if preferences.delivery_time == '08:00:00' %}selected{% endif %}>8:00 AM ✓</option>
                                    <option value="10:00:00" {% if preferences.delivery_time == '10:00:00' %}selected{% endif %}>10:00 AM</option>
                                    <option value="12:00:00" {% if preferences.delivery_time == '12:00:00' %}selected{% endif %}>12:00 PM (Noon)</option>
                                    <option value="14:00:00" {% if preferences.delivery_time == '14:00:00' %}selected{% endif %}>2:00 PM</option>
                                    <option value="16:00:00" {% if preferences.delivery_time == '16:00:00' %}selected{% endif %}>4:00 PM</option>
                                    <option value="18:00:00" {% if preferences.delivery_time == '18:00:00' %}selected{% endif %}>6:00 PM</option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-clock"></i> Select your preferred delivery time (server time: PST/PDT)
                                    <br><i class="fas fa-check-circle text-success"></i> Times marked with ✓ are actively scheduled
                                </small>
                            </div>

                            <!-- Delivery Day (for weekly) -->
                            <div class="form-group {% if preferences.frequency != 'weekly' %}hidden{% endif %}" id="deliveryDayGroup">
                                <label for="deliveryDaySelect"><strong>Day of Week</strong></label>
                                <select class="form-control" id="deliveryDaySelect">
                                    <option value="1" {% if preferences.delivery_day == 1 %}selected{% endif %}>Monday</option>
                                    <option value="2" {% if preferences.delivery_day == 2 %}selected{% endif %}>Tuesday</option>
                                    <option value="3" {% if preferences.delivery_day == 3 %}selected{% endif %}>Wednesday</option>
                                    <option value="4" {% if preferences.delivery_day == 4 %}selected{% endif %}>Thursday</option>
                                    <option value="5" {% if preferences.delivery_day == 5 %}selected{% endif %}>Friday</option>
                                    <option value="6" {% if preferences.delivery_day == 6 %}selected{% endif %}>Saturday</option>
                                    <option value="7" {% if preferences.delivery_day == 7 %}selected{% endif %}>Sunday</option>
                                </select>
                                <small class="form-text text-muted">
                                    Day of week for weekly digest delivery
                                </small>
                            </div>

                            <hr class="my-4">

                            <h5 class="mb-3">Filters</h5>

                            <!-- Min Spam Score -->
                            <div class="form-group">
                                <label for="minSpamScore"><strong>Minimum Spam Score</strong></label>
                                <input type="number" class="form-control" id="minSpamScore"
                                       value="{{ preferences.min_spam_score }}" min="0" max="100" step="0.5">
                                <small class="form-text text-muted">
                                    Only include emails with spam score equal to or above this value (0-100)
                                </small>
                            </div>

                            <!-- Max Emails -->
                            <div class="form-group">
                                <label for="maxEmails"><strong>Maximum Emails Per Digest</strong></label>
                                <input type="number" class="form-control" id="maxEmails"
                                       value="{{ preferences.max_emails }}" min="1" max="100" step="1">
                                <small class="form-text text-muted">
                                    Limit the number of emails shown in each digest (1-100)
                                </small>
                            </div>

                            <!-- Include Released -->
                            <div class="form-group">
                                <div class="custom-control custom-checkbox">
                                    <input type="checkbox" class="custom-control-input" id="includeReleased"
                                           {% if preferences.include_released %}checked{% endif %}>
                                    <label class="custom-control-label" for="includeReleased">
                                        Include recently released emails (last 7 days)
                                    </label>
                                </div>
                                <small class="form-text text-muted">
                                    Show emails you've already released in addition to quarantined ones
                                </small>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Last Digest Info -->
                        {% if preferences.last_sent_at %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Last Digest Sent:</strong> {{ preferences.last_sent_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            ({{ preferences.last_email_count }} emails)
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="btn-group" role="group">
                            <button type="submit" class="btn btn-primary" id="saveButton">
                                <i class="fas fa-save"></i> Save Preferences
                            </button>
                            <button type="button" class="btn btn-secondary" id="testButton">
                                <i class="fas fa-paper-plane"></i> Send Digest Now
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Recent Digests Log -->
            {% if recent_digests %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Digest History</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Sent At</th>
                                    <th>Frequency</th>
                                    <th>Emails</th>
                                    <th>Status</th>
                                    <th>Actions Taken</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for digest in recent_digests %}
                                <tr>
                                    <td>{{ digest.sent_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>
                                        <span class="badge badge-info">{{ digest.frequency }}</span>
                                    </td>
                                    <td>{{ digest.email_count }}</td>
                                    <td>
                                        {% if digest.status == 'sent' %}
                                        <span class="badge badge-success">Sent</span>
                                        {% elif digest.status == 'failed' %}
                                        <span class="badge badge-danger">Failed</span>
                                        {% else %}
                                        <span class="badge badge-warning">{{ digest.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ digest.actions_taken or 0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
// Show/hide settings panel when toggle changes
document.getElementById('enabledSwitch').addEventListener('change', function() {
    const panel = document.getElementById('settingsPanel');
    if (this.checked) {
        panel.classList.remove('hidden');
    } else {
        panel.classList.add('hidden');
    }
});

// Show/hide delivery day for weekly frequency
document.getElementById('frequencySelect').addEventListener('change', function() {
    const dayGroup = document.getElementById('deliveryDayGroup');
    if (this.value === 'weekly') {
        dayGroup.classList.remove('hidden');
    } else {
        dayGroup.classList.add('hidden');
    }
});

// Save preferences
document.getElementById('notificationForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const button = document.getElementById('saveButton');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    const data = {
        enabled: document.getElementById('enabledSwitch').checked,
        frequency: document.getElementById('frequencySelect').value,
        delivery_time: document.getElementById('deliveryTimeSelect').value,
        delivery_day: parseInt(document.getElementById('deliveryDaySelect').value),
        min_spam_score: parseFloat(document.getElementById('minSpamScore').value),
        max_emails: parseInt(document.getElementById('maxEmails').value),
        include_released: document.getElementById('includeReleased').checked
    };

    try {
        const response = await fetch('/api/quarantine-notifications/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            alert('✅ Preferences saved successfully!');
            location.reload();
        } else {
            alert('❌ Error: ' + result.message);
        }
    } catch (error) {
        alert('❌ Error saving preferences: ' + error);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
});

// Send test digest
document.getElementById('testButton').addEventListener('click', async function() {
    if (!confirm('Send a test digest now? This will send an email to {{ current_user.email }}')) {
        return;
    }

    const button = this;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    try {
        const response = await fetch('/api/quarantine-notifications/send-test', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('✅ Test digest sent! Check your email at {{ current_user.email }}');
        } else {
            alert('❌ Error: ' + result.message);
        }
    } catch (error) {
        alert('❌ Error sending test: ' + error);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
});
</script>
{% endblock %}
