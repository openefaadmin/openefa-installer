{% extends "base.html" %}

{% block title %}User Messages - OpenEFA{% endblock %}

{% block extra_css %}
<style nonce="{{ csp_nonce }}">
    /* High spam filter */
    .spam-filter-hidden {
        display: none !important;
    }

    body {
        background-color: #f8f9fa;
    }

    .preview-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .search-container {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .nav-pills .nav-link {
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        margin-right: 0.25rem;
        transition: all 0.2s;
    }

    .nav-pills .nav-link:hover {
        background-color: #e9ecef;
    }

    .nav-pills .nav-link.active {
        background-color: #0d6efd;
        color: white;
    }

    .email-card {
        border-left: 4px solid #dee2e6;
        transition: all 0.2s;
        margin-bottom: 0.75rem;
        background: white;
    }

    .email-card:hover {
        border-left-color: #0d6efd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .email-card.spam-email {
        border-left-color: #dc3545;
    }

    .email-card.clean-email {
        border-left-color: #28a745;
    }

    .email-card.suspicious-email {
        border-left-color: #ffc107;
    }

    .badge-spam-high {
        background-color: #dc3545;
        color: white;
    }

    .badge-spam-medium {
        background-color: #ffc107;
        color: #000;
    }

    .badge-spam-low {
        background-color: #28a745;
        color: white;
    }

    .stat-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 120px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .action-btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }

    .email-preview {
        display: none;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        max-height: 300px;
        overflow-y: auto;
    }

    /* Toast notification styles */
    .toast-notification {
        position: fixed;
        top: 80px;
        right: 20px;
        background-color: #28a745;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 9999;
        animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
        opacity: 1;
        font-weight: 500;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }

    /* Back to Top Button */
    #backToTopBtn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 99;
        border: none;
        outline: none;
        background-color: #667eea;
        color: white;
        cursor: pointer;
        padding: 15px;
        border-radius: 50%;
        font-size: 18px;
        width: 50px;
        height: 50px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        opacity: 0;
        visibility: hidden;
    }

    #backToTopBtn.show {
        opacity: 1;
        visibility: visible;
    }

    #backToTopBtn:hover {
        background-color: #764ba2;
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    #backToTopBtn:active {
        transform: translateY(-1px);
    }

    /* Legend icon styling */
    .legend-icon {
        cursor: pointer;
        font-size: 1.2rem;
        color: #0d6efd;
        margin-left: 0.5rem;
    }

    .legend-icon:hover {
        color: #0a58ca;
    }

    .delivery-badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        font-size: 0.85em;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        margin-right: 0.5em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-2">
    <!-- Header Banner -->
    <div class="preview-banner mb-2">
        <div>
            <h4 class="mb-1"><i class="fas fa-inbox me-2"></i>User Messages</h4>
            <p class="mb-0 small">30-day archive of all processed emails with quarantine management</p>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="mb-2 d-flex gap-3 flex-wrap">
        <div class="stat-card">
            <span class="stat-label">Total Messages</span>
            <span class="stat-value text-primary">{{ total_count or 0 }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Expiring Soon</span>
            <span class="stat-value text-warning">{{ stats.expiring_soon or 0 }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Avg Spam Score</span>
            <span class="stat-value {% if stats.avg_spam_score >= 10 %}text-danger{% elif stats.avg_spam_score >= 6 %}text-warning{% else %}text-success{% endif %}">
                {{ "%.1f"|format(stats.avg_spam_score or 0) }}
            </span>
        </div>
        <div class="stat-card threat-breakdown-trigger" style="cursor: pointer;" title="Click for detailed breakdown">
            <span class="stat-label">
                Threats Prevented
                <i class="fas fa-info-circle text-muted" style="font-size: 0.8em;"
                   title="Critical security threats blocked (spam score ≥50 or categorized as spam/phishing/virus)"></i>
            </span>
            <span class="stat-value text-success">
                <i class="fas fa-shield-alt"></i> {{ stats.security_threats or 0 }}
            </span>
            <small class="text-muted d-block mt-1" style="font-size: 0.75em;">
                Click for breakdown
            </small>
        </div>
    </div>

    <!-- Filters & Search -->
    <div class="search-container mb-3">
        <form method="GET" action="{{ url_for('quarantine_view') }}">
            <div class="row align-items-end g-3">
                <div class="col-md-4">
                    <label class="form-label small fw-bold">
                        <i class="fas fa-search"></i> Search
                    </label>
                    <input type="text"
                           class="form-control"
                           name="search"
                           value="{{ search_query }}"
                           placeholder="Search by ID, sender, subject, recipients, or message-id">
                </div>

                {% if current_user.is_admin() %}
                <div class="col-md-3">
                    <label class="form-label small fw-bold">
                        <i class="fas fa-globe"></i> Domain
                    </label>
                    <select class="form-select" name="domain">
                        <option value="">All Domains</option>
                        {% for domain in user_domains %}
                        <option value="{{ domain }}" {% if domain_filter == domain %}selected{% endif %}>
                            {{ domain }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <div class="col-md-{% if current_user.is_admin() %}3{% else %}4{% endif %}">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-filter"></i> Apply
                    </button>
                    <a href="{{ url_for('quarantine_view') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo"></i> Reset
                    </a>
                </div>

                <!-- Delivery Status Legend -->
                <div class="col-md-{% if current_user.is_admin() %}2{% else %}4{% endif %}">
                    <span class="legend-icon"
                          data-bs-toggle="popover"
                          data-bs-placement="bottom"
                          data-bs-html="true"
                          data-bs-trigger="click"
                          data-bs-content="<div class='text-start'><strong>Delivery Status Legend:</strong><br><span class='delivery-badge bg-info'>D</span> Delivered<br><span class='delivery-badge bg-warning'>Q</span> Quarantined<br><span class='delivery-badge bg-success'>R</span> Released</div>"
                          title="Status Legend">
                        ℹ️ Legend
                    </span>
                </div>
            </div>

            <!-- Content Search Option -->
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               id="search_content"
                               name="search_content"
                               value="1"
                               {% if search_content == '1' %}checked{% endif %}>
                        <label class="form-check-label small text-muted" for="search_content">
                            <i class="fas fa-file-alt"></i> Include email content in search (slower)
                        </label>
                    </div>
                </div>
            </div>
            <!-- High Spam Filter Option -->
            <div class="row mt-2">
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               id="hide_high_spam"
                               >
                        <label class="form-check-label small text-muted" for="hide_high_spam">
                            <i class="fas fa-eye-slash"></i> Hide high spam (score &ge; 40)
                        </label>
                        <span id="hidden_spam_count" class="badge bg-secondary ms-2 d-none"></span>
                    </div>
                </div>
            </div>

            <!-- Hidden field to preserve status -->
            <input type="hidden" name="status" value="{{ status_filter }}">
        </form>

        <!-- Status Tabs -->
        <div class="mt-3">
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link {% if status_filter == 'all' and show_deleted != '1' %}active{% endif %}"
                       href="?status=all{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                        <i class="fas fa-list"></i> All
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if status_filter == 'clean' and show_deleted != '1' %}active{% endif %}"
                       href="?status=clean{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                        <i class="fas fa-check-circle"></i> Clean
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if status_filter == 'suspicious' and show_deleted != '1' %}active{% endif %}"
                       href="?status=suspicious{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                        <i class="fas fa-question-circle"></i> Suspicious
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if (status_filter == 'quarantined' or not status_filter) and show_deleted != '1' %}active{% endif %}"
                       href="?status=quarantined{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                        <i class="fas fa-pause-circle"></i> Quarantined
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if status_filter == 'spam' and show_deleted != '1' %}active{% endif %}"
                       href="?status=spam{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                        <i class="fas fa-exclamation-triangle"></i> Spam
                    </a>
                </li>
                <li class="nav-item ms-auto">
                    {% if show_deleted == '1' %}
                    <a class="nav-link btn btn-outline-danger active" href="?status={{ status_filter }}{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                        <i class="fas fa-eye-slash"></i> Hide Deleted
                    </a>
                    {% else %}
                    <a class="nav-link btn btn-outline-secondary" href="?status={{ status_filter }}{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}&show_deleted=1">
                        <i class="fas fa-trash"></i> Show Deleted
                    </a>
                    {% endif %}
                </li>
            </ul>
        </div>
    </div>

    <!-- Email List -->
    {% if quarantined_emails %}
    <div class="mb-4">
        {% for email in quarantined_emails %}
        {% set email_class = 'spam-email' if email.spam_score >= 10.0 else ('suspicious-email' if email.spam_score >= 7.0 else 'clean-email') %}
        <div class="card email-card {{ email_class }}">
            <div class="card-body">
                <div class="row align-items-center">
                    <!-- Email Info -->
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 me-2">
                                <i class="fas fa-envelope"></i>
                                {% if email.quarantine_reason == 'dangerous_attachment' %}
                                <strong style="color: #dc3545; font-weight: 900;">⚠️ {{ email.subject or 'No Subject' }}</strong>
                                {% else %}
                                <strong>{{ email.subject or 'No Subject' }}</strong>
                                {% endif %}
                            </h6>
                            {% if email.spam_score is not none %}
                                {% if email.spam_score >= 10.0 %}
                                <span class="badge badge-spam-high">{{ "%.1f"|format(email.spam_score) }}</span>
                                {% elif email.spam_score >= 6.0 %}
                                <span class="badge badge-spam-medium">{{ "%.1f"|format(email.spam_score) }}</span>
                                {% else %}
                                <span class="badge badge-spam-low">{{ "%.1f"|format(email.spam_score) }}</span>
                                {% endif %}
                            {% endif %}
                            {% if email.quarantine_status == 'held' %}
                            <span class="badge bg-warning text-dark" style="font-weight: bold;" title="Quarantined">Q</span>
                            {% elif email.quarantine_status == 'released' %}
                            <span class="badge bg-success" style="font-weight: bold;" title="Delivered">D</span>
                            {% elif email.quarantine_status == 'deleted' %}
                            <span class="badge bg-danger" style="font-weight: bold;" title="Deleted">X</span>
                            {% endif %}
                        </div>
                        <div class="text-muted small">
                            <div><i class="fas fa-hashtag"></i> ID: {{ email.id }} | Msg-ID: {{ email.message_id[:30] if email.message_id else 'N/A' }}...</div>
                            <div><i class="fas fa-user"></i> From: {{ email.sender or 'Unknown' }}</div>
                            {% if email.source_ip %}
                            <div><i class="fas fa-globe"></i> Source IP: <span class="badge bg-secondary">{{ email.source_ip }}</span>{% if email.source_country %} <span class="badge bg-info">{{ email.source_country }}</span>{% endif %}</div>
                            {% endif %}
                            <div><i class="fas fa-users"></i> To: {{ email.recipients[:50] }}{% if email.recipients|length > 50 %}...{% endif %}</div>
                            <div><i class="fas fa-clock"></i> {{ email.timestamp|userdate('long') if email.timestamp else 'N/A' }}</div>
                        </div>
                    </div>

                    <!-- Metadata -->
                    <div class="col-md-3">
                        {% if email.quarantine_reason == 'dangerous_attachment' %}
                        <div class="mb-1">
                            <span class="badge bg-danger" style="font-size: 0.9rem; font-weight: bold;">
                                <i class="fas fa-exclamation-triangle"></i> MALWARE DETECTED
                            </span>
                        </div>
                        {% endif %}
                        {% if email.virus_detected %}
                        <div class="mb-1">
                            <span class="badge bg-danger">
                                <i class="fas fa-virus"></i> VIRUS DETECTED
                            </span>
                        </div>
                        {% endif %}
                        {% if email.email_category %}
                        <div class="mb-1">
                            <span class="badge {% if email.email_category in ['spam', 'phishing'] %}bg-danger{% else %}bg-primary{% endif %}">
                                {{ email.email_category }}
                            </span>
                        </div>
                        {% endif %}

                        {# Training Indicators - Ham (Not Spam) and Spam #}
                        {% set ham_count = email.not_spam_train_count|default(0) %}
                        {% set spam_count = email.spam_train_count|default(0) %}
                        {% set max_train = 3 %}
                        <div class="mb-1">
                            <small class="text-muted d-block mb-1"><strong>Training Status:</strong></small>
                            {# Ham Training (Not Spam) #}
                            {% if ham_count >= max_train %}
                                <span class="badge bg-success" title="Ham training complete - marked as legitimate {{ ham_count }} times">
                                    <i class="fas fa-check-circle"></i> Ham {{ ham_count }}/{{ max_train }}
                                </span>
                            {% elif ham_count > 0 %}
                                <span class="badge bg-info" title="Ham training in progress - click 'Not Spam' {{ max_train - ham_count }} more time(s)">
                                    <i class="fas fa-thumbs-up"></i> Ham {{ ham_count }}/{{ max_train }}
                                </span>
                            {% else %}
                                <span class="badge bg-light text-dark" title="No ham training - click 'Not Spam' to train as legitimate email">
                                    <i class="fas fa-thumbs-up"></i> Ham 0/{{ max_train }}
                                </span>
                            {% endif %}

                            {# Spam Training #}
                            {% if spam_count >= max_train %}
                                <span class="badge bg-danger" title="Spam training complete - marked as spam {{ spam_count }} times">
                                    <i class="fas fa-ban"></i> Spam {{ spam_count }}/{{ max_train }}
                                </span>
                            {% elif spam_count > 0 %}
                                <span class="badge bg-warning text-dark" title="Spam training in progress - click 'Spam' {{ max_train - spam_count }} more time(s)">
                                    <i class="fas fa-exclamation-triangle"></i> Spam {{ spam_count }}/{{ max_train }}
                                </span>
                            {% else %}
                                <span class="badge bg-light text-dark" title="No spam training - click 'Spam' to train as unwanted email">
                                    <i class="fas fa-ban"></i> Spam 0/{{ max_train }}
                                </span>
                            {% endif %}
                        </div>

                        {% if email.detected_language %}
                        <div class="mb-1">
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-language"></i> {{ email.detected_language }}
                            </span>
                        </div>
                        {% endif %}
                        {% if email.has_attachments %}
                        <div>
                            <span class="badge bg-info">
                                <i class="fas fa-paperclip"></i> Attachments
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    <div class="col-md-3 text-end">
                        <div class="mb-2">
                            <button class="btn btn-sm btn-success action-btn btn-release-email me-1"
                                    data-email-id="{{ email.id }}"
                                    title="Release and deliver this email">
                                <i class="fas fa-paper-plane"></i> Release
                            </button>
                            {% set train_count = email.not_spam_train_count|default(0) %}
                            {% set max_count = 3 %}
                            <button class="btn btn-sm {% if train_count >= max_count %}btn-secondary{% else %}btn-outline-success{% endif %} action-btn btn-not-spam-email"
                                    data-email-id="{{ email.id }}"
                                    data-train-count="{{ train_count }}"
                                    data-max-count="{{ max_count }}"
                                    {% if train_count >= max_count %}disabled{% endif %}
                                    title="Mark as not spam for training (click up to 3 times for optimal learning)">
                                <i class="fas fa-check-circle"></i> Not Spam
                                {% if train_count > 0 %}({{ train_count }}/{{ max_count }}){% endif %}
                            </button>
                        </div>
                        <div>
                            {% set spam_train_count = email.spam_train_count|default(0) %}
                            <button class="btn btn-sm {% if spam_train_count >= max_count %}btn-secondary{% else %}btn-danger{% endif %} action-btn btn-mark-spam-email me-1"
                                    data-email-id="{{ email.id }}"
                                    data-train-count="{{ spam_train_count }}"
                                    data-max-count="{{ max_count }}"
                                    {% if spam_train_count >= max_count %}disabled{% endif %}
                                    title="Mark as spam for training (click up to 3 times for optimal learning)">
                                <i class="fas fa-ban"></i> Spam
                                {% if spam_train_count > 0 %}({{ spam_train_count }}/{{ max_count }}){% endif %}
                            </button>
                            <a href="/quarantine/{{ email.id }}" class="btn btn-sm btn-primary action-btn me-1">
                                <i class="fas fa-eye"></i> View
                            </a>
                            {% if current_user.is_admin() %}
                            <button class="btn btn-sm btn-outline-danger action-btn btn-delete-email"
                                    data-email-id="{{ email.id }}"
                                    title="Delete this email">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Preview Toggle -->
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary btn-toggle-preview"
                            data-email-id="{{ email.id }}">
                        <i class="fas fa-chevron-down"></i> Show Preview
                    </button>
                </div>

                <!-- Email Preview (Hidden by default) -->
                <div id="preview-{{ email.id }}" class="email-preview">
                    <strong>Content Preview:</strong>
                    <div class="mt-2">
                        {{ email.content_summary or 'No preview available' }}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination Info -->
    <div class="row mt-3 mb-3">
        <div class="col text-center text-muted">
            Showing page {{ page }} of {{ total_pages }} ({{ total_count }} total emails)
        </div>
    </div>

    <!-- Pagination Controls -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <!-- First Page -->
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link"
                   href="?page=1&status={{ status_filter }}{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                    &laquo;&laquo;
                </a>
            </li>

            <!-- Previous Page -->
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link"
                   href="?page={{ page - 1 }}&status={{ status_filter }}{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                    &laquo;
                </a>
            </li>

            <!-- Page Numbers -->
            {% set start_page = [page - 2, 1]|max %}
            {% set end_page = [start_page + 4, total_pages]|min %}
            {% set start_page = [end_page - 4, 1]|max %}

            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link"
                       href="?page={{ p }}&status={{ status_filter }}{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                        {{ p }}
                    </a>
                </li>
            {% endfor %}

            <!-- Next Page -->
            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                <a class="page-link"
                   href="?page={{ page + 1 }}&status={{ status_filter }}{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                    &raquo;
                </a>
            </li>

            <!-- Last Page -->
            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                <a class="page-link"
                   href="?page={{ total_pages }}&status={{ status_filter }}{% if search_query %}&search={{ search_query }}{% endif %}{% if domain_filter %}&domain={{ domain_filter }}{% endif %}">
                    &raquo;&raquo;
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            {% if domain_filter %}
            <h5 class="text-muted">No emails found for {{ domain_filter }}</h5>
            <p class="text-muted">
                {% if total_count == 0 %}
                No emails have been received for this domain yet.
                {% else %}
                Try adjusting your filters or search criteria.
                {% endif %}
            </p>
            {% else %}
            <h5 class="text-muted">No messages found</h5>
            <p class="text-muted">Try adjusting your filters or search criteria</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Back to Top Button -->
    <button id="backToTopBtn" title="Back to top">
        <i class="fas fa-arrow-up"></i>
    </button>

</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
    // Toast notification function
    function showToast(message, type = 'success', duration = 5000) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        if (type === 'error') {
            toast.style.backgroundColor = '#dc3545';
        }
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, duration);
    }

    function togglePreview(emailId) {
        const preview = document.getElementById('preview-' + emailId);
        const btn = event.target.closest('button');

        // Check computed style instead of inline style
        const isHidden = window.getComputedStyle(preview).display === 'none';

        if (isHidden) {
            preview.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Preview';
        } else {
            preview.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-chevron-down"></i> Show Preview';
        }
    }

    function deleteEmail(emailId) {
        if (!confirm('Delete this email permanently?')) {
            return;
        }

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/api/quarantine/${emailId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                reason: 'User confirmed spam'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('✓ Email deleted', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('✗ Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('✗ Failed to delete email: ' + error, 'error');
        });
    }

    // Attach event listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Preview toggle buttons
        document.querySelectorAll('.btn-toggle-preview').forEach(button => {
            button.addEventListener('click', function() {
                const emailId = this.getAttribute('data-email-id');
                togglePreview(emailId);
            });
        });

        // Delete email buttons
        document.querySelectorAll('.btn-delete-email').forEach(button => {
            button.addEventListener('click', function() {
                const emailId = this.getAttribute('data-email-id');
                deleteEmail(emailId);
            });
        });

        // Release email buttons
        document.querySelectorAll('.btn-release-email').forEach(button => {
            button.addEventListener('click', function() {
                const emailId = this.getAttribute('data-email-id');
                releaseEmail(emailId);
            });
        });

        // Not spam buttons
        document.querySelectorAll('.btn-not-spam-email').forEach(button => {
            button.addEventListener('click', function() {
                const emailId = this.getAttribute('data-email-id');
                markNotSpam(emailId);
            });
        });

        // Mark spam buttons
        document.querySelectorAll('.btn-mark-spam-email').forEach(button => {
            button.addEventListener('click', function() {
                const emailId = this.getAttribute('data-email-id');
                markAsSpam(emailId);
            });
        });

        // Initialize Bootstrap popovers for legend
        const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
        const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
    });

    function releaseEmail(emailId) {
        if (!confirm('Release this email and deliver it to the recipient(s)?')) return;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/api/quarantine/${emailId}/release`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast('✓ Email released successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('✗ Error: ' + (data.error || data.message || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Release error:', error);
            showToast('✗ Error releasing email: ' + (error.error || error.message || error), 'error');
        });
    }

    function markNotSpam(emailId) {
        // Find the button for this email
        const button = document.querySelector(`.btn-not-spam-email[data-email-id="${emailId}"]`);
        if (!button) return;

        const currentCount = parseInt(button.dataset.trainCount || 0);
        const maxCount = parseInt(button.dataset.maxCount || 3);

        // Check if already at max
        if (currentCount >= maxCount) {
            showToast('⚠ Training limit reached (3/3)', 'warning');
            return;
        }

        // Show confirmation
        const nextCount = currentCount + 1;
        if (!confirm(`Mark this email as not spam? This will train the spam filter.\n\nTraining iteration: ${nextCount}/3\n\nYou can mark it ${maxCount - nextCount} more time(s) after this for optimal learning.`)) return;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/api/quarantine/${emailId}/not-spam`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const trainCount = data.train_count || nextCount;
                const maxCount = data.max_count || 3;

                // Update button text and data
                button.dataset.trainCount = trainCount;
                const icon = button.querySelector('i');
                if (trainCount >= maxCount) {
                    button.innerHTML = icon.outerHTML + ` Not Spam (${trainCount}/${maxCount})`;
                    button.disabled = true;
                    button.classList.remove('btn-outline-success');
                    button.classList.add('btn-secondary');
                    showToast(`✓ Email marked as not spam (${trainCount}/${maxCount}) - Maximum training reached`, 'success');

                    // Reload page after reaching max training to show updated training indicator badge
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    button.innerHTML = icon.outerHTML + ` Not Spam (${trainCount}/${maxCount})`;
                    showToast(`✓ Email marked as not spam (${trainCount}/${maxCount}) - You can train ${maxCount - trainCount} more time(s)`, 'success');
                }
            } else {
                showToast('✗ Error: ' + (data.error || data.message || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Mark not spam error:', error);
            showToast('✗ Error: ' + (error.error || error.message || error), 'error');
        });
    }

    function markAsSpam(emailId) {
        // Find the button for this email
        const button = document.querySelector(`.btn-mark-spam-email[data-email-id="${emailId}"]`);
        if (!button) return;

        const currentCount = parseInt(button.dataset.trainCount || 0);
        const maxCount = parseInt(button.dataset.maxCount || 3);

        // Check if already at max
        if (currentCount >= maxCount) {
            showToast('⚠ Training limit reached (3/3)', 'warning');
            return;
        }

        const nextCount = currentCount + 1;
        if (!confirm(`Mark this email as spam? This will train the spam filter.\n\nTraining iteration: ${nextCount}/3\n\nYou can mark it ${maxCount - nextCount} more time(s) after this for optimal learning.`)) return;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/api/emails/${emailId}/mark-spam`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const trainCount = data.train_count || nextCount;
                const maxCount = data.max_count || 3;

                // Update button text and data
                button.dataset.trainCount = trainCount;
                const icon = button.querySelector('i');
                if (trainCount >= maxCount) {
                    button.innerHTML = icon.outerHTML + ` Spam (${trainCount}/${maxCount})`;
                    button.disabled = true;
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-secondary');
                    showToast(`✓ Email marked as spam (${trainCount}/${maxCount}) - Maximum training reached`, 'success');

                    // Reload page after reaching max training to show updated training indicator badge
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    button.innerHTML = icon.outerHTML + ` Spam (${trainCount}/${maxCount})`;
                    showToast(`✓ Email marked as spam (${trainCount}/${maxCount}) - You can train ${maxCount - trainCount} more time(s)`, 'success');
                }
            } else {
                showToast('✗ Error: ' + (data.error || data.message || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Mark spam error:', error);
            showToast('✗ Error: ' + (error.error || error.message || error), 'error');
        });
    }

    // Auto-focus search box when content search checkbox is clicked
    const searchContentCheckbox = document.getElementById('search_content');
    const searchInput = document.querySelector('input[name="search"]');

    if (searchContentCheckbox && searchInput) {
        searchContentCheckbox.addEventListener('change', function() {
            // Focus the search box when checkbox is toggled
            searchInput.focus();
            // Select all text if there's any in the search box
            if (searchInput.value) {
                searchInput.select();
            }
        });
    }

    // Back to Top Button Functionality
    const backToTopBtn = document.getElementById('backToTopBtn');

    // Show button when user scrolls down 300px
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTopBtn.classList.add('show');
        } else {
            backToTopBtn.classList.remove('show');
        }
    });

    // Smooth scroll to top when button is clicked
    backToTopBtn.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // Threat Breakdown Modal
    function showThreatBreakdown() {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Fetch threat breakdown data
        fetch('/api/threat-breakdown', {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            const modalHtml = `
                <div class="modal fade" id="threatModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-shield-alt"></i> Threats Prevented - Last 30 Days
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted mb-3">
                                    <i class="fas fa-calendar-alt"></i>
                                    Threats identified and prevented in the last 30 days.
                                </p>
                                <div class="list-group">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-fire text-danger"></i>
                                            <strong>Critical Spam</strong>
                                            <br><small class="text-muted">Spam score ≥ 50</small>
                                        </div>
                                        <span class="badge bg-danger rounded-pill">${data.critical_spam || 0}</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-envelope text-warning"></i>
                                            <strong>Categorized Spam</strong>
                                            <br><small class="text-muted">Identified as spam</small>
                                        </div>
                                        <span class="badge bg-warning rounded-pill">${data.categorized_spam || 0}</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-fish-fins text-info"></i>
                                            <strong>Phishing Attempts</strong>
                                            <br><small class="text-muted">Malicious links/content</small>
                                        </div>
                                        <span class="badge bg-info rounded-pill">${data.phishing || 0}</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-virus text-danger"></i>
                                            <strong>Virus/Malware</strong>
                                            <br><small class="text-muted">Dangerous attachments</small>
                                        </div>
                                        <span class="badge bg-danger rounded-pill">${data.virus || 0}</span>
                                    </div>
                                </div>
                                <div class="alert alert-success mt-3 mb-0">
                                    <strong><i class="fas fa-check-circle"></i> Total Prevented:</strong>
                                    ${data.total || 0} security threats blocked
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('threatModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('threatModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error fetching threat breakdown:', error);
            showToast('Error loading threat breakdown', 'error');
        });
    }

    // Attach click event to threat breakdown trigger
    document.addEventListener('DOMContentLoaded', function() {
        const threatTrigger = document.querySelector('.threat-breakdown-trigger');
        if (threatTrigger) {
            threatTrigger.addEventListener('click', showThreatBreakdown);
        }
    });
</script>
<!-- High Spam Filter Script -->
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='high-spam-filter.js') }}"></script>

{% endblock %}
