{% extends 'base.html' %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Chat Interface -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-robot"></i> SpaCy AI Assistant
                        <span class="badge bg-warning text-dark float-end">BETA</span>
                    </h4>
                    <small>Ask me anything about your emails!</small>
                </div>

                <div class="card-body" style="height: 600px; display: flex; flex-direction: column;">
                    <!-- Chat Messages -->
                    <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                        <!-- Welcome message -->
                        <div class="message assistant-message">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-text">
                                    <strong>Hello! I'm your SpaCy AI Assistant.</strong><br>
                                    I can help you with:
                                    <ul class="mb-0 mt-2">
                                        <li>Finding emails ("Show me my spam")</li>
                                        <li>Taking actions ("Release email 152145")</li>
                                        <li>Getting statistics ("How effective is the spam filter?")</li>
                                        <li>Managing whitelists and blocklists</li>
                                    </ul>
                                    Try asking me something!
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="input-group">
                        <input
                            type="text"
                            id="userInput"
                            class="form-control form-control-lg"
                            placeholder="Ask me anything... (e.g., 'Show me spam from today')"
                            autocomplete="off"
                        >
                        <button class="btn btn-primary btn-lg" id="sendButton" type="button">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Quick Examples</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action quick-query" data-query="Show me my spam">
                            <i class="fas fa-envelope text-danger"></i> Show me my spam
                        </a>
                        <a href="#" class="list-group-item list-group-item-action quick-query" data-query="Show me spam from today">
                            <i class="fas fa-calendar-day text-warning"></i> Show spam from today
                        </a>
                        <a href="#" class="list-group-item list-group-item-action quick-query" data-query="Show me clean emails">
                            <i class="fas fa-check-circle text-success"></i> Show clean emails
                        </a>
                        <a href="#" class="list-group-item list-group-item-action quick-query" data-query="How effective is the spam filter?">
                            <i class="fas fa-chart-line text-info"></i> Show effectiveness
                        </a>
                        <a href="#" class="list-group-item list-group-item-action quick-query" data-query="Show me expiring emails">
                            <i class="fas fa-clock text-warning"></i> Show expiring emails
                        </a>
                        <a href="#" class="list-group-item list-group-item-action quick-query" data-query="What did the system learn today?">
                            <i class="fas fa-brain text-primary"></i> Show learning activity
                        </a>
                    </div>

                    <div class="mt-4">
                        <h6 class="text-muted">Example Commands:</h6>
                        <small class="text-muted">
                            • Release email 152145<br>
                            • Block sender@spam.com<br>
                            • Add amazon.com to whitelist<br>
                            • Show emails with score over 20<br>
                            • Show me spam from last week
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style nonce="{{ csp_nonce }}">
#chatMessages {
    scroll-behavior: smooth;
}

.message {
    display: flex;
    margin-bottom: 20px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
}

.assistant-message .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.user-message {
    flex-direction: row-reverse;
}

.user-message .message-avatar {
    background: #28a745;
    color: white;
    margin-left: 12px;
    margin-right: 0;
}

.message-content {
    flex: 1;
    max-width: 80%;
}

.message-text {
    background: white;
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.user-message .message-text {
    background: #e3f2fd;
    text-align: right;
}

.results-table {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 10px;
}

.results-table table {
    font-size: 0.9em;
}

.action-confirmation {
    background: #fff3cd;
    border: 1px solid #ffc107;
    padding: 12px;
    border-radius: 8px;
    margin-top: 10px;
}

.action-buttons {
    margin-top: 10px;
}

.typing-indicator {
    display: inline-block;
}

.typing-indicator span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #999;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}
</style>

<script nonce="{{ csp_nonce }}">
let conversationHistory = [];
let pendingAction = null; // Store pending action data

// Send message
document.getElementById('sendButton').addEventListener('click', sendMessage);
document.getElementById('userInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Quick query buttons
document.querySelectorAll('.quick-query').forEach(el => {
    el.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('userInput').value = this.dataset.query;
        sendMessage();
    });
});

function sendMessage() {
    const input = document.getElementById('userInput');
    const query = input.value.trim();

    if (!query) return;

    // Add user message to chat
    addMessage(query, 'user');
    input.value = '';

    // Show typing indicator
    showTypingIndicator();

    // Send to API
    fetch('/api/assistant', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        handleResponse(data);
    })
    .catch(error => {
        removeTypingIndicator();
        addMessage('Sorry, an error occurred: ' + error.message, 'assistant');
    });
}

function addMessage(text, sender) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;

    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

    const content = document.createElement('div');
    content.className = 'message-content';

    const textDiv = document.createElement('div');
    textDiv.className = 'message-text';
    textDiv.innerHTML = text;

    content.appendChild(textDiv);
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function showTypingIndicator() {
    const messagesDiv = document.getElementById('chatMessages');
    const indicator = document.createElement('div');
    indicator.id = 'typingIndicator';
    indicator.className = 'message assistant-message';
    indicator.innerHTML = `
        <div class="message-avatar"><i class="fas fa-robot"></i></div>
        <div class="message-content">
            <div class="message-text">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
    `;
    messagesDiv.appendChild(indicator);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
}

function handleResponse(data) {
    if (!data.success) {
        addMessage(`❌ ${data.explanation || data.error}`, 'assistant');
        return;
    }

    // Add explanation
    let responseHTML = `<strong>${data.explanation}</strong>`;

    // Handle query results
    if (data.results && data.results.length > 0) {
        responseHTML += formatResults(data.results, data.result_type);
    } else if (data.results && data.results.length === 0) {
        responseHTML += '<p class="mt-2 text-muted">No results found.</p>';
    }

    // Handle actions that need confirmation
    if (data.requires_confirmation && data.action_data) {
        responseHTML += formatActionConfirmation(data.action_data);
    }

    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message assistant-message';
    messageDiv.innerHTML = `
        <div class="message-avatar"><i class="fas fa-robot"></i></div>
        <div class="message-content">
            <div class="message-text">${responseHTML}</div>
        </div>
    `;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function formatResults(results, resultType) {
    if (resultType === 'email_list') {
        return formatEmailList(results);
    } else if (resultType === 'effectiveness_stats') {
        return formatEffectivenessStats(results);
    } else if (resultType === 'volume_stats') {
        return formatVolumeStats(results);
    } else if (resultType === 'learning_stats') {
        return formatLearningStats(results);
    } else {
        // Generic table format
        return formatGenericTable(results);
    }
}

function formatEmailList(emails) {
    let html = '<div class="results-table"><table class="table table-sm table-hover mt-2">';
    html += '<thead><tr><th>ID</th><th>From</th><th>Subject</th><th>Score</th><th>Date</th></tr></thead><tbody>';

    emails.forEach(email => {
        const date = new Date(email.timestamp).toLocaleDateString();
        const subject = email.subject ? email.subject.substring(0, 50) : 'No subject';
        html += `<tr>
            <td><a href="/email/${email.id}" target="_blank">${email.id}</a></td>
            <td>${email.sender}</td>
            <td>${subject}</td>
            <td><span class="badge bg-${email.spam_score > 10 ? 'danger' : email.spam_score > 5 ? 'warning' : 'success'}">${parseFloat(email.spam_score).toFixed(1)}</span></td>
            <td>${date}</td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    html += `<p class="text-muted mt-2"><small>Showing ${emails.length} results. Click ID to view details.</small></p>`;
    return html;
}

function formatEffectivenessStats(stats) {
    const latest = stats[0];
    return `
        <div class="mt-3">
            <h6>Current Performance:</h6>
            <ul>
                <li><strong>F1 Score:</strong> ${latest.f1_score}%</li>
                <li><strong>Detection Rate:</strong> ${latest.detection_rate}%</li>
                <li><strong>Precision:</strong> ${latest.precision_score}%</li>
                <li><strong>Overall Effectiveness:</strong> ${latest.effectiveness_score}%</li>
                <li><strong>Total Emails:</strong> ${latest.total_emails}</li>
                <li><strong>Spam Caught:</strong> ${latest.spam_caught}</li>
            </ul>
        </div>
    `;
}

function formatVolumeStats(stats) {
    const s = stats[0];
    return `
        <div class="mt-3">
            <ul>
                <li><strong>Total Emails:</strong> ${s.total_emails}</li>
                <li><strong>Quarantined:</strong> ${s.quarantined}</li>
                <li><strong>Delivered:</strong> ${s.delivered}</li>
                <li><strong>Deleted:</strong> ${s.deleted}</li>
                <li><strong>Average Spam Score:</strong> ${parseFloat(s.avg_spam_score).toFixed(2)}</li>
            </ul>
        </div>
    `;
}

function formatLearningStats(stats) {
    const s = stats[0];
    return `
        <div class="mt-3">
            <ul>
                <li><strong>Patterns Updated:</strong> ${s.patterns_updated}</li>
                <li><strong>Spam Patterns:</strong> ${s.spam_patterns}</li>
                <li><strong>Safe (Ham) Patterns:</strong> ${s.ham_patterns}</li>
                <li><strong>Spam Examples Learned:</strong> ${s.total_spam_examples}</li>
                <li><strong>Ham Examples Learned:</strong> ${s.total_ham_examples}</li>
            </ul>
        </div>
    `;
}

function formatGenericTable(results) {
    if (results.length === 0) return '';

    const keys = Object.keys(results[0]);
    let html = '<div class="results-table"><table class="table table-sm mt-2"><thead><tr>';
    keys.forEach(key => html += `<th>${key}</th>`);
    html += '</tr></thead><tbody>';

    results.forEach(row => {
        html += '<tr>';
        keys.forEach(key => html += `<td>${row[key]}</td>`);
        html += '</tr>';
    });

    html += '</tbody></table></div>';
    return html;
}

function formatActionConfirmation(actionData) {
    // Store action data globally for button handlers
    pendingAction = actionData;

    const confirmId = 'confirm-btn-' + Date.now();
    const cancelId = 'cancel-btn-' + Date.now();

    // Use setTimeout to attach event listeners after DOM is updated
    setTimeout(() => {
        const confirmBtn = document.getElementById(confirmId);
        const cancelBtn = document.getElementById(cancelId);

        if (confirmBtn) {
            confirmBtn.addEventListener('click', confirmAction);
        }
        if (cancelBtn) {
            cancelBtn.addEventListener('click', cancelAction);
        }
    }, 100);

    return `
        <div class="action-confirmation">
            <strong>⚠️ Confirmation Required</strong>
            <p>This action will be performed: ${actionData.method} ${actionData.endpoint}</p>
            <div class="action-buttons">
                <button id="${confirmId}" class="btn btn-success btn-sm">
                    <i class="fas fa-check"></i> Confirm
                </button>
                <button id="${cancelId}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    `;
}

function confirmAction() {
    if (!pendingAction) {
        addMessage('❌ No pending action to confirm.', 'assistant');
        return;
    }

    // Execute the action via API
    fetch(pendingAction.endpoint, {
        method: pendingAction.method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: pendingAction.payload ? JSON.stringify(pendingAction.payload) : null
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addMessage('✅ Action completed successfully!', 'assistant');
        } else {
            addMessage('❌ Action failed: ' + (data.error || 'Unknown error'), 'assistant');
        }
        pendingAction = null; // Clear pending action
    })
    .catch(error => {
        addMessage('❌ Error executing action: ' + error.message, 'assistant');
        pendingAction = null; // Clear pending action
    });
}

function cancelAction() {
    pendingAction = null; // Clear pending action
    addMessage('Action cancelled.', 'assistant');
}
</script>
{% endblock %}
