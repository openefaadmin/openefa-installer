{% extends "base.html" %}

{% block title %}Cleanup Settings - OpenEFA{% endblock %}

{% block extra_css %}
<style nonce="{{ csp_nonce }}">
    .preview-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .settings-card {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: #28a745;
    }

    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    .info-box {
        background-color: #f8f9fa;
        border-left: 4px solid #17a2b8;
        padding: 1rem;
        border-radius: 5px;
    }

    .warning-box {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        border-radius: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-2">
    <!-- Header Banner -->
    <div class="preview-banner mb-2">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1"><i class="fas fa-tools me-2"></i>Email Administration</h4>
                <p class="mb-0 small">Email cleanup, manual release, and maintenance</p>
            </div>
            <div>
                <a href="{{ url_for('config_dashboard') }}" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Back to Config
                </a>
            </div>
        </div>
    </div>
    <!-- Alert messages -->
    <div id="alert-container"></div>

    <!-- Main Settings -->
    <div class="row">
        <div class="col-md-8">
            {% if current_user.is_superadmin() %}
            <!-- Release to Superadmin -->
            <div class="card settings-card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-paper-plane"></i> Release Email to Superadmin</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Forward ANY email (quarantined, delivered, or blocked) to yourself for detailed analysis. The original email remains unchanged and is delivered to you with warning headers.
                    </p>

                    <div class="mb-3">
                        <label for="release-message-id" class="form-label">
                            <i class="fas fa-envelope"></i> Message ID
                        </label>
                        <input type="number"
                               class="form-control"
                               id="release-message-id"
                               placeholder="Enter email ID (e.g., 164131)"
                               min="1">
                        <small class="form-text text-muted">
                            Find the ID in the quarantine or email list (e.g., "ID: 164131")
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="release-destination" class="form-label">
                            <i class="fas fa-user"></i> Destination
                        </label>
                        <input type="email"
                               class="form-control"
                               id="release-destination"
                               value="{{ current_user.email }}"
                               readonly
                               disabled>
                        <small class="form-text text-muted">
                            Email will be sent to your superadmin account
                        </small>
                    </div>

                    <div class="info-box mb-3">
                        <h6><i class="fas fa-info-circle"></i> What Happens</h6>
                        <ul class="mb-0 small">
                            <li>Email is fetched from system by ID (any status)</li>
                            <li>Warning headers are added to indicate source</li>
                            <li>Email is delivered to {{ current_user.email }}</li>
                            <li>Original email remains unchanged in system</li>
                            <li>Action is logged for audit trail</li>
                            <li>Works with quarantined AND delivered emails</li>
                        </ul>
                    </div>

                    <button id="btn-release-email" class="btn btn-primary w-100">
                        <i class="fas fa-paper-plane"></i> Release to My Email
                    </button>
                </div>
            </div>

            <!-- EFA Collective Registration -->
            <div class="card settings-card border-primary" id="collective-registration-card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
                     style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collective-registration-body">
                    <h5 class="mb-0"><i class="fas fa-id-card"></i> EFA Collective Registration</h5>
                    <span id="collective-header-badge" class="badge bg-light text-dark" style="display: none;">
                        <i class="fas fa-check-circle text-success"></i> Approved
                    </span>
                </div>
                <div class="collapse show" id="collective-registration-body">
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            Register your OpenEFA instance with the EFA Collective to submit spam reports
                            and access shared threat intelligence.
                        </p>

                        <!-- Registration Status -->
                        <div class="mb-3 p-3 border rounded" id="collective-status-box">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong><i class="fas fa-signal"></i> Registration Status</strong>
                            <span id="collective-status-badge" class="badge bg-secondary">Checking...</span>
                        </div>
                        <div class="small">
                            <div class="row">
                                <div class="col-4 text-muted">System ID:</div>
                                <div class="col-8"><code id="collective-system-id">Loading...</code></div>
                            </div>
                            <div class="row mt-1">
                                <div class="col-4 text-muted">Public IP:</div>
                                <div class="col-8"><code id="collective-public-ip">Detecting...</code></div>
                            </div>
                            <div class="row mt-1" id="collective-registered-date-row" style="display: none;">
                                <div class="col-4 text-muted">Registered:</div>
                                <div class="col-8"><span id="collective-registered-date">-</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Benefits Info -->
                    <div class="info-box mb-3">
                        <h6><i class="fas fa-star"></i> Membership Benefits</h6>
                        <ul class="mb-0 small">
                            <li>Submit spam/false positive reports to improve detection</li>
                            <li>Access shared threat intelligence feeds</li>
                            <li>Community-contributed blocklists</li>
                            <li>Priority support and advanced features</li>
                        </ul>
                    </div>

                    <!-- Registration Form (shown when not registered) -->
                    <div id="collective-register-form" style="display: none;">
                        <div class="mb-3">
                            <label for="collective-admin-email" class="form-label small">
                                <i class="fas fa-envelope"></i> Admin Contact Email
                            </label>
                            <input type="email" class="form-control form-control-sm" id="collective-admin-email"
                                   value="{{ current_user.email }}" placeholder="admin@yourdomain.com">
                        </div>
                        <div class="mb-3">
                            <label for="collective-org-name" class="form-label small">
                                <i class="fas fa-building"></i> Organization Name <small class="text-muted">(optional)</small>
                            </label>
                            <input type="text" class="form-control form-control-sm" id="collective-org-name"
                                   placeholder="Your Company or Organization">
                        </div>
                        <button id="btn-collective-register" class="btn btn-primary w-100">
                            <i class="fas fa-user-plus"></i> Register with EFA Collective
                        </button>
                    </div>

                    <!-- Pending Status (shown when pending approval) -->
                    <div id="collective-pending-status" style="display: none;">
                        <div class="alert alert-warning mb-2">
                            <i class="fas fa-clock"></i> <strong>Registration Pending</strong><br>
                            <small>Your registration is awaiting approval. This typically takes 1-2 business days.</small>
                        </div>
                        <button id="btn-collective-check-status" class="btn btn-outline-secondary btn-sm w-100">
                            <i class="fas fa-sync"></i> Check Status
                        </button>
                    </div>

                    <!-- Approved Status (shown when approved) -->
                    <div id="collective-approved-status" style="display: none;">
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle"></i> <strong>Registration Approved</strong><br>
                            <small>You can now submit reports to the EFA Collective.</small>
                        </div>
                    </div>

                    <!-- Rejected Status -->
                        <div id="collective-rejected-status" style="display: none;">
                            <div class="alert alert-danger mb-2">
                                <i class="fas fa-times-circle"></i> <strong>Registration Rejected</strong><br>
                                <small id="collective-rejection-reason">Contact support@openefa.com for assistance.</small>
                            </div>
                            <button id="btn-collective-reregister" class="btn btn-outline-primary btn-sm w-100">
                                <i class="fas fa-redo"></i> Submit New Registration
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report to EFA Collective (only shown when registered) -->
            <div class="card settings-card border-info" id="collective-report-section" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-globe"></i> Report to EFA Collective</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Report spam that got through, false positives, or new spam patterns to the EFA Collective.
                        Your report helps improve detection for the entire OpenEFA community.
                    </p>

                    <div class="mb-3">
                        <label for="collective-message-id" class="form-label">
                            <i class="fas fa-envelope"></i> Message ID
                        </label>
                        <input type="number"
                               class="form-control"
                               id="collective-message-id"
                               placeholder="Enter email ID (e.g., 164131)"
                               min="1">
                        <small class="form-text text-muted">
                            Find the ID in the quarantine or email list
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-tag"></i> Issue Type
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="report-type" id="report-spam-missed" value="spam_missed" checked>
                            <label class="form-check-label" for="report-spam-missed">
                                Spam got through <small class="text-muted">(should have been blocked)</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="report-type" id="report-false-positive" value="false_positive">
                            <label class="form-check-label" for="report-false-positive">
                                False positive <small class="text-muted">(legitimate email was blocked)</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="report-type" id="report-new-pattern" value="new_pattern">
                            <label class="form-check-label" for="report-new-pattern">
                                New spam pattern <small class="text-muted">(seeing a new type of spam)</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="report-type" id="report-bug" value="bug">
                            <label class="form-check-label" for="report-bug">
                                Bug / unexpected behavior
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="collective-notes" class="form-label">
                            <i class="fas fa-comment"></i> Notes <small class="text-muted">(optional)</small>
                        </label>
                        <textarea class="form-control" id="collective-notes" rows="2"
                                  placeholder="Describe the issue or provide context..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-paperclip"></i> Include in Report
                        </label>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include-headers" checked>
                                    <label class="form-check-label small" for="include-headers">Full headers</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include-body" checked>
                                    <label class="form-check-label small" for="include-body">Email body</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include-ml" checked>
                                    <label class="form-check-label small" for="include-ml">ML scores</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include-modules" checked>
                                    <label class="form-check-label small" for="include-modules">Module breakdown</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-box mb-3">
                        <h6><i class="fas fa-info-circle"></i> What Gets Sent</h6>
                        <ul class="mb-0 small">
                            <li>Original email with all headers (as .eml)</li>
                            <li>Complete scoring breakdown and analysis</li>
                            <li>ML classification results</li>
                            <li>Authentication results (SPF/DKIM/DMARC)</li>
                            <li>Your system ID (for validation)</li>
                            <li>Report is sent to <strong>efacollective@openefa.com</strong></li>
                        </ul>
                    </div>

                    <button id="btn-report-collective" class="btn btn-info w-100 text-white">
                        <i class="fas fa-paper-plane"></i> Submit to EFA Collective
                    </button>
                </div>
            </div>
            {% endif %}

            <div class="card settings-card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-trash-alt"></i> Automatic Cleanup</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                        <div>
                            <h6 class="mb-1">Enable Automatic Cleanup</h6>
                            <p class="text-muted mb-0 small">
                                Automatically delete expired quarantine emails after {{ retention_days }} days
                            </p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cleanup-toggle"
                                   {% if cleanup_enabled %}checked{% endif %}
                                   onchange="toggleCleanup()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="info-box mb-3">
                        <h6><i class="fas fa-info-circle"></i> How It Works</h6>
                        <ul class="mb-0">
                            <li>Cleanup runs daily at 2:00 AM</li>
                            <li>Only emails past their expiration date are removed</li>
                            <li>Emails are kept for {{ retention_days }} days from quarantine date</li>
                            <li>Deleted emails cannot be recovered after cleanup</li>
                        </ul>
                    </div>

                    <div class="warning-box">
                        <h6><i class="fas fa-exclamation-triangle"></i> Important</h6>
                        <p class="mb-0">
                            When cleanup is disabled, expired emails will remain in the database indefinitely.
                            This may impact system performance over time.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Recent Cleanup Activity -->
            <div class="card settings-card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Cleanup Activity</h5>
                </div>
                <div class="card-body">
                    {% if cleanup_logs %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Emails Deleted</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in cleanup_logs %}
                                <tr>
                                    <td>{{ log.date }}</td>
                                    <td>
                                        {% if log.status == 'success' %}
                                        <span class="badge bg-success">Success</span>
                                        {% elif log.status == 'skipped' %}
                                        <span class="badge bg-secondary">Skipped</span>
                                        {% else %}
                                        <span class="badge bg-danger">Error</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ log.deleted_count }}</td>
                                    <td class="small text-muted">{{ log.details }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">
                        <i class="fas fa-inbox"></i> No cleanup activity recorded yet
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="col-md-4">
            <div class="card settings-card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted mb-1">Current Status</h6>
                        <h4>
                            {% if cleanup_enabled %}
                            <span class="badge bg-success">Enabled</span>
                            {% else %}
                            <span class="badge bg-secondary">Disabled</span>
                            {% endif %}
                        </h4>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h6 class="text-muted mb-1">Retention Period</h6>
                        <h4>{{ retention_days }} days</h4>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h6 class="text-muted mb-1">Next Cleanup</h6>
                        <h4>{{ next_cleanup_time }}</h4>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <h6 class="text-muted mb-1">Emails Expiring Soon</h6>
                        <h4>{{ expiring_count }}</h4>
                        <small class="text-muted">In next 7 days</small>
                    </div>
                    <hr>
                    <div>
                        <h6 class="text-muted mb-1">Total Expired</h6>
                        <h4>{{ expired_count }}</h4>
                        <small class="text-muted">Ready for cleanup</small>
                    </div>
                </div>
            </div>

            <div class="card settings-card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-trash-alt"></i> Spam Cleanup</h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        Auto soft-delete old high-scoring spam emails based on age and score.
                        Emails remain viewable via "Show Deleted" button.
                    </p>
                    <div class="info-box mb-3">
                        <strong>Policy:</strong>
                        <ul class="small mb-0 mt-2">
                            <li>Score ≥15.0: 7 days</li>
                            <li>Score 10.0-14.9: 30 days</li>
                            <li>Score 6.0-9.9: 90 days</li>
                            <li>Score &lt;6.0: Never</li>
                        </ul>
                    </div>
                    <button id="btn-spam-cleanup-dry-run" class="btn btn-warning btn-sm w-100 mb-2">
                        <i class="fas fa-eye"></i> Preview (Dry Run)
                    </button>
                    <button id="btn-spam-cleanup" class="btn btn-danger btn-sm w-100">
                        <i class="fas fa-trash-alt"></i> Run Spam Cleanup
                    </button>
                </div>
            </div>

            <div class="card settings-card">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-cog"></i> Advanced</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="runCleanupNow()">
                        <i class="fas fa-play"></i> Run Cleanup Now
                    </button>
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="viewLogs()">
                        <i class="fas fa-file-alt"></i> View Full Logs
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-alt"></i> Cleanup Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="logs-content" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 1rem; border-radius: 5px;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
function showAlert(message, type = 'success', timeout = 5000) {
    const alertContainer = document.getElementById('alert-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    alertContainer.appendChild(alertDiv);
    if (timeout > 0) {
        setTimeout(() => alertDiv.remove(), timeout);
    }
}

function toggleCleanup() {
    const enabled = document.getElementById('cleanup-toggle').checked;

    fetch('/api/cleanup-settings/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled: enabled})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`<i class="fas fa-check-circle"></i> ${data.message}`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${data.error}`, 'danger');
            // Revert toggle
            document.getElementById('cleanup-toggle').checked = !enabled;
        }
    })
    .catch(error => {
        showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${error}`, 'danger');
        document.getElementById('cleanup-toggle').checked = !enabled;
    });
}

function runCleanupNow() {
    if (!confirm('Run cleanup now? This will delete all expired quarantine emails immediately.')) {
        return;
    }

    showAlert('<i class="fas fa-spinner fa-spin"></i> Running cleanup...', 'info');

    fetch('/api/cleanup-settings/run-now', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`<i class="fas fa-check-circle"></i> ${data.message}`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${error}`, 'danger');
    });
}

function runSpamCleanupDryRun() {
    console.log('Running spam cleanup dry run...');

    try {
        showAlert('<i class="fas fa-spinner fa-spin"></i> Running spam cleanup preview (dry run)...', 'info');

        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (!csrfMeta) {
            console.error('CSRF meta tag not found');
            showAlert('<i class="fas fa-exclamation-circle"></i> Error: CSRF token not found. Please refresh the page.', 'danger');
            return;
        }

        const csrfToken = csrfMeta.getAttribute('content');
        console.log('CSRF token retrieved:', csrfToken ? 'Yes' : 'No');

        fetch('/api/cleanup-settings/spam-cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ dry_run: true })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                const stats = data.stats;
                let message = `<strong>Preview Results:</strong><br>`;
                message += `<ul class="mb-0 mt-2">`;
                message += `<li>Very High Spam (≥15.0, >7d): ${stats.very_high_spam}</li>`;
                message += `<li>High Spam (10.0-14.9, >30d): ${stats.high_spam}</li>`;
                message += `<li>Suspicious (6.0-9.9, >90d): ${stats.suspicious}</li>`;
                message += `<li><strong>Total: ${stats.total} emails</strong></li>`;
                message += `</ul>`;
                message += `<small class="text-muted mt-2 d-block">These emails would be soft deleted (still viewable via "Show Deleted")</small>`;
                showAlert(`<i class="fas fa-eye"></i> ${message}`, 'warning', 30000); // 30 second timeout
            } else {
                showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${error}`, 'danger');
        });
    } catch (e) {
        console.error('Exception in runSpamCleanupDryRun:', e);
        showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${e.message}`, 'danger');
    }
}

function runSpamCleanup() {
    if (!confirm('⚠️ Run spam cleanup? This will SOFT DELETE old high-scoring spam emails.\n\nEmails will still be viewable via "Show Deleted" button and will be hard deleted after 30 days.\n\nContinue?')) {
        return;
    }

    showAlert('<i class="fas fa-spinner fa-spin"></i> Running spam cleanup... This may take a few minutes.', 'info');

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch('/api/cleanup-settings/spam-cleanup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ dry_run: false })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const stats = data.stats;
            let message = `<strong>Cleanup Complete!</strong><br>`;
            message += `<ul class="mb-0 mt-2">`;
            message += `<li>Very High Spam (≥15.0, >7d): ${stats.very_high_spam}</li>`;
            message += `<li>High Spam (10.0-14.9, >30d): ${stats.high_spam}</li>`;
            message += `<li>Suspicious (6.0-9.9, >90d): ${stats.suspicious}</li>`;
            message += `<li><strong>Total: ${stats.total} emails soft deleted</strong></li>`;
            message += `</ul>`;
            showAlert(`<i class="fas fa-check-circle"></i> ${message}`, 'success');
            setTimeout(() => location.reload(), 3000);
        } else {
            showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${error}`, 'danger');
    });
}

function viewLogs() {
    fetch('/api/cleanup-settings/logs')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('logs-content').textContent = data.logs;
            new bootstrap.Modal(document.getElementById('logsModal')).show();
        } else {
            showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${error}`, 'danger');
    });
}

function releaseEmailToSuperadmin() {
    const messageId = document.getElementById('release-message-id').value;

    if (!messageId || messageId <= 0) {
        showAlert('<i class="fas fa-exclamation-circle"></i> Please enter a valid Message ID', 'warning');
        return;
    }

    if (!confirm(`Release email ID ${messageId} to your email for analysis?\n\nThe email will remain in quarantine.`)) {
        return;
    }

    showAlert('<i class="fas fa-spinner fa-spin"></i> Releasing email...', 'info');

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch('/api/release-to-superadmin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ message_id: parseInt(messageId) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`<i class="fas fa-check-circle"></i> ${data.message}`, 'success');
            document.getElementById('release-message-id').value = '';
        } else {
            showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${error}`, 'danger');
    });
}

function reportToCollective() {
    const messageId = document.getElementById('collective-message-id').value;
    const reportType = document.querySelector('input[name="report-type"]:checked').value;
    const notes = document.getElementById('collective-notes').value;
    const includeHeaders = document.getElementById('include-headers').checked;
    const includeBody = document.getElementById('include-body').checked;
    const includeMl = document.getElementById('include-ml').checked;
    const includeModules = document.getElementById('include-modules').checked;

    if (!messageId || messageId <= 0) {
        showAlert('<i class="fas fa-exclamation-circle"></i> Please enter a valid Message ID', 'warning');
        return;
    }

    if (!confirm(`Submit email ID ${messageId} to EFA Collective?\n\nReport type: ${reportType.replace('_', ' ')}\n\nThis helps improve spam detection for the entire OpenEFA community.`)) {
        return;
    }

    showAlert('<i class="fas fa-spinner fa-spin"></i> Submitting report to EFA Collective...', 'info');

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch('/api/report-to-collective', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            message_id: parseInt(messageId),
            report_type: reportType,
            notes: notes,
            include_headers: includeHeaders,
            include_body: includeBody,
            include_ml: includeMl,
            include_modules: includeModules
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`<i class="fas fa-check-circle"></i> ${data.message}`, 'success');
            document.getElementById('collective-message-id').value = '';
            document.getElementById('collective-notes').value = '';
        } else {
            showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${error}`, 'danger');
    });
}

// Attach event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const btnSpamCleanupDryRun = document.getElementById('btn-spam-cleanup-dry-run');
    const btnSpamCleanup = document.getElementById('btn-spam-cleanup');
    const btnReleaseEmail = document.getElementById('btn-release-email');

    if (btnSpamCleanupDryRun) {
        btnSpamCleanupDryRun.addEventListener('click', runSpamCleanupDryRun);
        console.log('Spam cleanup dry run button listener attached');
    }

    if (btnSpamCleanup) {
        btnSpamCleanup.addEventListener('click', runSpamCleanup);
        console.log('Spam cleanup button listener attached');
    }

    if (btnReleaseEmail) {
        btnReleaseEmail.addEventListener('click', releaseEmailToSuperadmin);
        console.log('Release email button listener attached');
    }

    // EFA Collective report button
    const btnReportCollective = document.getElementById('btn-report-collective');
    if (btnReportCollective) {
        btnReportCollective.addEventListener('click', reportToCollective);
        console.log('Report to collective button listener attached');
    }

    // Add Enter key handler for collective message ID input
    const collectiveMessageIdInput = document.getElementById('collective-message-id');
    if (collectiveMessageIdInput) {
        collectiveMessageIdInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                reportToCollective();
            }
        });
    }

    // Add Enter key handler for message ID input
    const releaseMessageIdInput = document.getElementById('release-message-id');
    if (releaseMessageIdInput) {
        releaseMessageIdInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                releaseEmailToSuperadmin();
            }
        });
        console.log('Enter key handler attached to message ID input');
    }

    // EFA Collective Registration buttons
    const btnCollectiveRegister = document.getElementById('btn-collective-register');
    if (btnCollectiveRegister) {
        btnCollectiveRegister.addEventListener('click', registerWithCollective);
    }

    const btnCollectiveCheckStatus = document.getElementById('btn-collective-check-status');
    if (btnCollectiveCheckStatus) {
        btnCollectiveCheckStatus.addEventListener('click', checkCollectiveStatus);
    }

    const btnCollectiveReregister = document.getElementById('btn-collective-reregister');
    if (btnCollectiveReregister) {
        btnCollectiveReregister.addEventListener('click', function() {
            // Reset UI to show registration form
            document.getElementById('collective-rejected-status').style.display = 'none';
            document.getElementById('collective-register-form').style.display = 'block';
        });
    }

    // Load collective status on page load
    loadCollectiveStatus();
});

// EFA Collective Registration Functions
let collectiveData = {
    system_id: null,
    public_ip: null,
    status: 'unknown'
};

function loadCollectiveStatus() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    fetch('/api/collective/status', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            collectiveData = data;
            updateCollectiveUI(data);
        } else {
            console.error('Failed to load collective status:', data.error);
            document.getElementById('collective-status-badge').textContent = 'Error';
            document.getElementById('collective-status-badge').className = 'badge bg-danger';
        }
    })
    .catch(error => {
        console.error('Error loading collective status:', error);
        document.getElementById('collective-status-badge').textContent = 'Error';
        document.getElementById('collective-status-badge').className = 'badge bg-danger';
    });
}

function updateCollectiveUI(data) {
    // Update system ID and public IP
    document.getElementById('collective-system-id').textContent = data.system_id || 'Not generated';
    document.getElementById('collective-public-ip').textContent = data.public_ip || 'Unable to detect';

    // Update status badge and show appropriate section
    const statusBadge = document.getElementById('collective-status-badge');
    const headerBadge = document.getElementById('collective-header-badge');
    const registrationBody = document.getElementById('collective-registration-body');
    const registerForm = document.getElementById('collective-register-form');
    const pendingStatus = document.getElementById('collective-pending-status');
    const approvedStatus = document.getElementById('collective-approved-status');
    const rejectedStatus = document.getElementById('collective-rejected-status');
    const reportSection = document.getElementById('collective-report-section');
    const registeredDateRow = document.getElementById('collective-registered-date-row');

    // Hide all sections first
    registerForm.style.display = 'none';
    pendingStatus.style.display = 'none';
    approvedStatus.style.display = 'none';
    rejectedStatus.style.display = 'none';
    reportSection.style.display = 'none';
    registeredDateRow.style.display = 'none';
    headerBadge.style.display = 'none';

    switch(data.status) {
        case 'unregistered':
            statusBadge.textContent = 'Not Registered';
            statusBadge.className = 'badge bg-secondary';
            registerForm.style.display = 'block';
            // Expand the card for registration
            if (!registrationBody.classList.contains('show')) {
                registrationBody.classList.add('show');
            }
            break;

        case 'pending':
            statusBadge.textContent = 'Pending Approval';
            statusBadge.className = 'badge bg-warning text-dark';
            pendingStatus.style.display = 'block';
            if (data.registered_at) {
                registeredDateRow.style.display = 'flex';
                document.getElementById('collective-registered-date').textContent = data.registered_at;
            }
            // Keep expanded while pending
            if (!registrationBody.classList.contains('show')) {
                registrationBody.classList.add('show');
            }
            break;

        case 'approved':
            statusBadge.textContent = 'Approved';
            statusBadge.className = 'badge bg-success';
            approvedStatus.style.display = 'block';
            reportSection.style.display = 'block';
            if (data.registered_at) {
                registeredDateRow.style.display = 'flex';
                document.getElementById('collective-registered-date').textContent = data.registered_at;
            }
            // Show header badge and collapse the card
            headerBadge.style.display = 'inline-block';
            registrationBody.classList.remove('show');
            break;

        case 'rejected':
            statusBadge.textContent = 'Rejected';
            statusBadge.className = 'badge bg-danger';
            rejectedStatus.style.display = 'block';
            if (data.rejection_reason) {
                document.getElementById('collective-rejection-reason').textContent = data.rejection_reason;
            }
            // Keep expanded for re-registration
            if (!registrationBody.classList.contains('show')) {
                registrationBody.classList.add('show');
            }
            break;

        default:
            statusBadge.textContent = 'Unknown';
            statusBadge.className = 'badge bg-secondary';
            registerForm.style.display = 'block';
    }
}

function registerWithCollective() {
    const adminEmail = document.getElementById('collective-admin-email').value;
    const orgName = document.getElementById('collective-org-name').value;

    if (!adminEmail) {
        showAlert('<i class="fas fa-exclamation-circle"></i> Please enter an admin contact email', 'warning');
        return;
    }

    if (!confirm('Register this OpenEFA instance with the EFA Collective?\n\nYour public IP and system information will be submitted for approval.')) {
        return;
    }

    showAlert('<i class="fas fa-spinner fa-spin"></i> Submitting registration...', 'info');

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch('/api/collective/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            admin_email: adminEmail,
            organization_name: orgName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`<i class="fas fa-check-circle"></i> ${data.message}`, 'success');
            // Reload status to update UI
            loadCollectiveStatus();
        } else {
            showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${error}`, 'danger');
    });
}

function checkCollectiveStatus() {
    showAlert('<i class="fas fa-spinner fa-spin"></i> Checking registration status...', 'info');

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch('/api/collective/check-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.status_changed) {
                showAlert(`<i class="fas fa-check-circle"></i> Status updated: ${data.status}`, 'success');
            } else {
                showAlert(`<i class="fas fa-info-circle"></i> Status unchanged: ${data.status}`, 'info');
            }
            loadCollectiveStatus();
        } else {
            showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert(`<i class="fas fa-exclamation-circle"></i> Error: ${error}`, 'danger');
    });
}
</script>
{% endblock %}
