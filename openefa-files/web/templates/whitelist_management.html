{% extends "base.html" %}

{% block title %}Whitelist Management - {{ domain }} - OpenEFA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<style nonce="{{ csp_nonce }}">
    .preview-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .config-card {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .stat-card {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .trust-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    .trust-high { background: #10b981; color: white; }
    .trust-medium { background: #f59e0b; color: white; }
    .trust-low { background: #ef4444; color: white; }

    .auth-badge {
        display: inline-block;
        padding: 0.2rem 0.4rem;
        border-radius: 0.2rem;
        font-size: 0.75rem;
        margin: 0 0.1rem;
    }
    .auth-spf { background: #e0e7ff; color: #3730a3; }
    .auth-dkim { background: #dbeafe; color: #1e40af; }
    .auth-dmarc { background: #dcfce7; color: #166534; }

    .sender-row:hover { background: #f9fafb; }
    .action-buttons { opacity: 0; transition: opacity 0.2s; }
    .sender-row:hover .action-buttons { opacity: 1; }
    .search-results { max-height: 400px; overflow-y: auto; }

    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        padding: 0.75rem 1.5rem;
    }

    .nav-tabs .nav-link.active {
        color: #667eea;
        background: transparent;
        border-bottom: 3px solid #667eea;
    }

    .nav-tabs {
        border-bottom: 1px solid #dee2e6;
    }

    /* Filter classes */
    .domain-filtered-hidden {
        display: none !important;
    }
    .search-filtered-hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-2">
    <!-- Header Banner -->
    <div class="preview-banner mb-2">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1"><i class="fas fa-user-check me-2"></i>Whitelist Management</h4>
                <p class="mb-0 small">
                    Manage trusted senders and domains for {{ domain }}
                    {% if multi_domain %} ({{ user_domains|length }} domains){% endif %}
                </p>
            </div>
            <div>
                <a href="{{ url_for('config_dashboard') }}" class="btn btn-light btn-sm me-2">
                    <i class="fas fa-arrow-left"></i> Back to Config
                </a>
                {% if user_domains|length > 1 %}
                <div class="dropdown d-inline-block">
                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-globe"></i> {{ domain }}
                    </button>
                    <ul class="dropdown-menu">
                        {% for d in user_domains %}
                            <li>
                                <a class="dropdown-item {% if d == domain %}active fw-bold{% endif %}" href="/whitelist/{{ d }}">
                                    {% if d == domain %}<i class="fas fa-check text-success"></i> {% endif %}
                                    {{ d }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                {% else %}
                <span class="badge bg-light text-dark">
                    <i class="fas fa-globe"></i> {{ domain }}
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="d-flex gap-2 flex-wrap mb-3">
        <div class="flex-fill">
            <div class="card stat-card bg-success text-white">
                <div class="card-body text-center py-2">
                    <h6 class="mb-1 small"><i class="fas fa-user-check"></i> Whitelisted Senders</h6>
                    <h4 class="mb-0">{{ stats.total_senders }}</h4>
                </div>
            </div>
        </div>
        <div class="flex-fill">
            <div class="card stat-card bg-info text-white">
                <div class="card-body text-center py-2">
                    <h6 class="mb-1 small"><i class="fas fa-globe"></i> Trusted Domains</h6>
                    <h4 class="mb-0">{{ stats.total_domains }}</h4>
                </div>
            </div>
        </div>
        <div class="flex-fill">
            <div class="card stat-card bg-warning text-white">
                <div class="card-body text-center py-2">
                    <h6 class="mb-1 small"><i class="fas fa-clock"></i> Recent Additions</h6>
                    <h4 class="mb-0">{{ stats.recent_additions|length }}</h4>
                </div>
            </div>
        </div>
        <div class="flex-fill">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body text-center py-2">
                    <h6 class="mb-1 small"><i class="fas fa-chart-line"></i> Active Senders</h6>
                    <h4 class="mb-0">{{ stats.most_active|length }}</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="card config-card">
        <div class="card-body">
            <!-- Action Tabs -->
            <ul class="nav nav-tabs mb-4" id="whitelistTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="senders-tab" data-bs-toggle="tab" data-bs-target="#senders">
                        <i class="fas fa-user-check"></i> Senders
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search">
                        <i class="fas fa-search"></i> Search Sender
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add">
                        <i class="fas fa-plus-circle"></i> Add to Whitelist
                    </button>
                </li>
                {% if current_user.is_admin() %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="domains-tab" data-bs-toggle="tab" data-bs-target="#domains">
                        <i class="fas fa-globe"></i> Domain Whitelist
                    </button>
                </li>
                {% endif %}
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="whitelistTabContent">
                <!-- Senders Tab -->
                <div class="tab-pane fade show active" id="senders" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Whitelisted Senders</h5>
                        <div class="d-flex gap-2">
                            {% if multi_domain %}
                            <select class="form-select" id="domainFilter" style="width: 200px;">
                                <option value="">All Domains</option>
                                {% for d in user_domains %}
                                <option value="{{ d }}" {% if d == domain %}selected{% endif %}>{{ d }}</option>
                                {% endfor %}
                            </select>
                            {% endif %}
                            <div class="input-group" style="width: 300px;">
                                <input type="text" class="form-control" id="filterSenders"
                                       placeholder="Filter senders..." autocomplete="off">
                                <button class="btn btn-outline-secondary" type="button" id="clearFilter">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Highlighted match section -->
                    <div id="highlightedMatch" style="display: none;" class="mb-3">
                        <div class="alert alert-info">
                            <h6 class="mb-2"><i class="bi bi-search"></i> Search Result:</h6>
                            <table class="table table-sm mb-0">
                                <tbody id="highlightedMatchBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {% if whitelist.senders %}
                    <div class="table-responsive">
                        <table class="table" id="sendersTable">
                            <thead>
                                <tr>
                                    <th>Email Address</th>
                                    {% if multi_domain %}
                                    <th>For Domain</th>
                                    {% endif %}
                                    <th>Trust Level</th>
                                    <th>Required Auth</th>
                                    <th>Added</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sendersTableBody">
                                {% for sender in whitelist.senders %}
                                <tr class="sender-row" data-for-domain="{{ sender.for_domain | default('') | lower }}">
                                    <td>
                                        <i class="bi bi-envelope"></i>
                                        {{ sender.email }}
                                    </td>
                                    {% if multi_domain %}
                                    <td>
                                        <span class="badge bg-info">{{ sender.for_domain | default('Not specified') }}</span>
                                    </td>
                                    {% endif %}
                                    <td>
                                        <span class="trust-badge {% if sender.trust_bonus >= 5 %}trust-high{% elif sender.trust_bonus >= 3 %}trust-medium{% else %}trust-low{% endif %}">
                                            {{ sender.trust_bonus }}
                                        </span>
                                    </td>
                                    <td>
                                        {% for auth in sender.require_auth %}
                                        <span class="auth-badge auth-{{ auth }}">{{ auth|upper }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ sender.added_date }}
                                            {% if sender.added_by %}
                                            <br>by {{ sender.added_by }}
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-primary edit-sender me-1"
                                                    data-email="{{ sender.email }}"
                                                    data-trust="{{ sender.trust_bonus }}"
                                                    data-auth="{{ sender.require_auth | join(',') }}"
                                                    data-for-domain="{{ sender.for_domain | default('') }}">
                                                E
                                            </button>
                                            <button class="btn btn-sm btn-danger remove-sender"
                                                    data-email="{{ sender.email }}">
                                                D
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No senders whitelisted for this domain yet.</p>
                    {% endif %}
                </div>

                <!-- Search Tab -->
                <div class="tab-pane fade" id="search" role="tabpanel">
                    <h5>Search for Sender</h5>
                    <form id="searchForm">
                        <div class="row">
                            <div class="col-md-8">
                                <input type="email" class="form-control" id="searchEmail"
                                       placeholder="Enter sender email address" required>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="searchDays">
                                    <option value="7">Last 7 days</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </form>

                    <div id="searchResults" class="mt-4" style="display: none;">
                        <h6>Search Results</h6>
                        <div class="alert alert-info" id="searchSummary" style="display: none;">
                            <i class="bi bi-info-circle"></i> <span id="searchSummaryText"></span>
                        </div>
                        <div class="search-results">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Subject / Sender</th>
                                        <th>Spam Score</th>
                                        <th>Verdict</th>
                                    </tr>
                                </thead>
                                <tbody id="searchResultsBody">
                                </tbody>
                            </table>
                        </div>
                        <button id="addSearchedSender" class="btn btn-success mt-2" style="display: none;">
                            <i class="bi bi-plus-circle"></i> Add to Whitelist
                        </button>
                    </div>
                </div>

                <!-- Add to Whitelist Tab -->
                <div class="tab-pane fade" id="add" role="tabpanel">
                    <h5>Add Sender to Whitelist</h5>
                    <form id="addSenderForm">
                        <div class="mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="addEmail" required
                                   placeholder="sender@example.com">
                        </div>

                        {% if multi_domain %}
                        <div class="mb-3">
                            <label class="form-label">For Domain</label>
                            <select class="form-select" id="addForDomain" required>
                                <option value="">Select domain...</option>
                                {% for d in user_domains %}
                                <option value="{{ d }}">{{ d }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Which domain should see this whitelist entry?</small>
                        </div>
                        {% else %}
                        <input type="hidden" id="addForDomain" value="{{ domain }}">
                        {% endif %}

                        <div class="mb-3">
                            <label class="form-label">Trust Bonus (Spam Score Reduction)</label>
                            <select class="form-select" id="addTrustBonus">
                                <option value="1">1 - Minimal trust</option>
                                <option value="2">2 - Low trust</option>
                                <option value="3" selected>3 - Medium trust</option>
                                <option value="4">4 - High trust</option>
                                <option value="5">5 - Very high trust</option>
                                <option value="10">10 - Complete trust</option>
                            </select>
                            <small class="text-muted">Points to subtract from spam score</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Required Authentication</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="authSpf" value="spf" checked>
                                <label class="form-check-label" for="authSpf">SPF</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="authDkim" value="dkim" checked>
                                <label class="form-check-label" for="authDkim">DKIM</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="authDmarc" value="dmarc">
                                <label class="form-check-label" for="authDmarc">DMARC</label>
                            </div>
                            <small class="text-muted">Select which authentication methods must pass</small>
                        </div>

                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Add to Whitelist
                        </button>
                    </form>
                </div>

                <!-- Domain Whitelist Tab (Admin Only) -->
                {% if current_user.is_admin() %}
                <div class="tab-pane fade" id="domains" role="tabpanel">
                    <h5>Whitelisted Domains</h5>

                    {% if whitelist.domains %}
                    <div class="table-responsive mb-4">
                        <table class="table" id="domainsTable">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    {% if multi_domain %}
                                    <th>For Domain</th>
                                    {% endif %}
                                    <th>Trust Level</th>
                                    <th>Bypass Checks</th>
                                    <th>Required Auth</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="domainsTableBody">
                                {% for domain_wl in whitelist.domains %}
                                <tr class="domain-row" data-for-domain="{{ domain_wl.for_domain | default('global') | lower }}">
                                    <td><i class="bi bi-globe"></i> {{ domain_wl.domain }}</td>
                                    {% if multi_domain %}
                                    <td>
                                        <span class="badge bg-info">{{ domain_wl.for_domain | default('global') }}</span>
                                    </td>
                                    {% endif %}
                                    <td>
                                        <span class="trust-badge trust-high">{{ domain_wl.trust_level }}</span>
                                    </td>
                                    <td>
                                        {% if domain_wl.bypass_bec %}
                                            <span class="badge bg-warning">BEC</span>
                                        {% endif %}
                                        {% if domain_wl.bypass_typo %}
                                            <span class="badge bg-warning">Typo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% for auth in domain_wl.require_auth %}
                                        <span class="auth-badge auth-{{ auth }}">{{ auth|upper }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary edit-domain me-1"
                                                data-domain="{{ domain_wl.domain }}"
                                                data-trust="{{ domain_wl.trust_level }}"
                                                data-auth="{{ domain_wl.require_auth | join(',') }}"
                                                data-bypass-bec="{{ domain_wl.bypass_bec | default(false) | lower }}"
                                                data-bypass-typo="{{ domain_wl.bypass_typo | default(false) | lower }}"
                                                data-for-domain="{{ domain_wl.for_domain | default('') }}">
                                            E
                                        </button>
                                        <button class="btn btn-sm btn-danger remove-domain"
                                                data-domain="{{ domain_wl.domain }}"
                                                data-for-domain="{{ domain_wl.for_domain | default('') }}">
                                            D
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No domains whitelisted yet.</p>
                    {% endif %}

                    <hr>

                    <h5>Add Domain to Whitelist</h5>
                    <form id="addDomainForm">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="addDomain"
                                       placeholder="example.com" required>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="domainTrustLevel">
                                    <option value="5">Trust Level 5</option>
                                    <option value="4">Trust Level 4</option>
                                    <option value="3" selected>Trust Level 3</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-plus"></i> Add Domain
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="bypassChecks">
                                <label class="form-check-label" for="bypassChecks">
                                    Bypass BEC and Typosquatting checks
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Edit Sender Modal -->
    <div class="modal fade" id="editSenderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Whitelist Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSenderForm">
                        <input type="hidden" id="editSenderEmail">
                        <div class="mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="text" class="form-control" id="editSenderEmailDisplay" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Trust Bonus</label>
                            <select class="form-select" id="editSenderTrust">
                                <option value="1">1 - Minimal trust</option>
                                <option value="2">2 - Low trust</option>
                                <option value="3">3 - Medium trust</option>
                                <option value="4">4 - High trust</option>
                                <option value="5">5 - Very high trust</option>
                                <option value="10">10 - Complete trust</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Required Authentication</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editAuthSpf" value="spf">
                                <label class="form-check-label" for="editAuthSpf">SPF</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editAuthDkim" value="dkim">
                                <label class="form-check-label" for="editAuthDkim">DKIM</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editAuthDmarc" value="dmarc">
                                <label class="form-check-label" for="editAuthDmarc">DMARC</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSenderEdit">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Domain Modal -->
    <div class="modal fade" id="editDomainModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Domain Whitelist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editDomainForm">
                        <input type="hidden" id="editDomainName">
                        <div class="mb-3">
                            <label class="form-label">Domain</label>
                            <input type="text" class="form-control" id="editDomainNameDisplay" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Trust Level</label>
                            <select class="form-select" id="editDomainTrust">
                                <option value="1">1 - Minimal trust</option>
                                <option value="2">2 - Low trust</option>
                                <option value="3">3 - Medium trust</option>
                                <option value="4">4 - High trust</option>
                                <option value="5">5 - Very high trust</option>
                                <option value="10">10 - Complete trust</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Required Authentication</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editDomainAuthSpf" value="spf">
                                <label class="form-check-label" for="editDomainAuthSpf">SPF</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editDomainAuthDkim" value="dkim">
                                <label class="form-check-label" for="editDomainAuthDkim">DKIM</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editDomainAuthDmarc" value="dmarc">
                                <label class="form-check-label" for="editDomainAuthDmarc">DMARC</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Bypass Checks</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editDomainBypassBec">
                                <label class="form-check-label" for="editDomainBypassBec">Bypass BEC checks</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editDomainBypassTypo">
                                <label class="form-check-label" for="editDomainBypassTypo">Bypass typosquatting checks</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveDomainEdit">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Most Active Whitelisted Senders -->
    {% if stats.most_active %}
    <div class="card config-card">
        <div class="card-header bg-white border-bottom">
            <h6 class="mb-0"><i class="fas fa-chart-line"></i> Most Active Whitelisted Senders (Last 30 Days)</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Sender</th>
                            <th>Email Count</th>
                            <th>Avg Spam Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for active in stats.most_active %}
                        <tr>
                            <td>{{ active.sender }}</td>
                            <td>{{ active.email_count }}</td>
                            <td>{{ "%.2f"|format(active.avg_score) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script nonce="{{ csp_nonce }}">
$(document).ready(function() {
    const domain = '{{ domain }}';

    // Store original senders data
    const allSenders = {{ whitelist.senders|tojson|safe }};
    console.log('Total senders loaded:', allSenders.length);

    // Check for URL parameter to pre-populate filter
    const urlParams = new URLSearchParams(window.location.search);
    const filterParam = urlParams.get('filter');
    if (filterParam) {
        $('#filterSenders').val(filterParam).trigger('input');
    }

    // Filter/search senders in the whitelist
    $('#filterSenders').on('input', function() {
        const searchTerm = $(this).val().toLowerCase().trim();

        // Show all rows if search is empty
        if (searchTerm === '') {
            $('#highlightedMatch').hide();
            document.querySelectorAll('#sendersTableBody tr.sender-row').forEach(function(row) {
                row.classList.remove('search-filtered-hidden');
                row.classList.remove('table-warning');
            });
            $('#noMatchMessage').remove();
            return;
        }

        // Find exact match in the data
        const exactMatch = allSenders.find(sender =>
            sender.email.toLowerCase() === searchTerm.toLowerCase()
        );

        // If exact match found, show it at the top
        if (exactMatch) {
            $('#highlightedMatch').show();
            const trustClass = exactMatch.trust_bonus >= 5 ? 'trust-high' :
                              exactMatch.trust_bonus >= 3 ? 'trust-medium' : 'trust-low';

            const authBadges = (exactMatch.require_auth || []).map(function(auth) {
                return '<span class="auth-badge auth-' + auth + '">' + auth.toUpperCase() + '</span>';
            }).join(' ');

            const addedBy = exactMatch.added_by ? ('<br>by ' + exactMatch.added_by) : '';

            const highlightedHtml = '<tr>' +
                '<td><i class="bi bi-envelope"></i> <strong>' + exactMatch.email + '</strong></td>' +
                '<td><span class="trust-badge ' + trustClass + '">' + exactMatch.trust_bonus + '</span></td>' +
                '<td>' + authBadges + '</td>' +
                '<td><small class="text-muted">' + (exactMatch.added_date || 'Unknown') + addedBy + '</small></td>' +
                '<td><button class="btn btn-sm btn-danger remove-sender-highlight" data-email="' + exactMatch.email + '">' +
                '<i class="bi bi-trash"></i></button></td>' +
                '</tr>';
            $('#highlightedMatchBody').html(highlightedHtml);
        } else {
            $('#highlightedMatch').hide();
        }

        // Filter the main table rows
        let matchFound = false;
        const rows = document.querySelectorAll('#sendersTableBody tr.sender-row');

        rows.forEach(function(row) {
            const emailCell = row.cells[0].textContent.trim().toLowerCase();

            if (emailCell.includes(searchTerm)) {
                row.classList.remove('search-filtered-hidden');
                matchFound = true;
                if (exactMatch && emailCell.includes(exactMatch.email.toLowerCase())) {
                    row.classList.add('table-warning');
                } else {
                    row.classList.remove('table-warning');
                }
            } else {
                row.classList.add('search-filtered-hidden');
                row.classList.remove('table-warning');
            }
        });

        // If no matches found
        if (!matchFound && !exactMatch) {
            if ($('#noMatchMessage').length === 0) {
                $('#sendersTableBody').append(
                    '<tr id="noMatchMessage"><td colspan="6" class="text-center text-muted">No matching senders found</td></tr>'
                );
            }
        } else {
            $('#noMatchMessage').remove();
        }
    });

    // Clear filter
    $('#clearFilter').click(function(e) {
        e.preventDefault();
        $('#filterSenders').val('').trigger('input');
    });

    // Domain filter (for multi-domain users)
    function applyDomainFilter() {
        const selectedDomain = $('#domainFilter').val().toLowerCase();
        console.log('=== Applying domain filter:', selectedDomain || 'all', '===');

        // Filter senders table using data-for-domain attribute
        const senderRows = document.querySelectorAll('#sendersTableBody tr.sender-row');
        console.log(`Total sender rows: ${senderRows.length}`);

        senderRows.forEach(function(row, idx) {
            const rowDomain = row.getAttribute('data-for-domain') || '';
            const emailCell = row.querySelector('td:first-child');
            const email = emailCell ? emailCell.textContent.trim() : 'unknown';

            console.log(`Sender ${idx}: email="${email}", data-for-domain="${rowDomain}"`);

            // Show all if "All Domains" selected
            if (selectedDomain === '') {
                row.classList.remove('domain-filtered-hidden');
            } else {
                // Show only rows matching the selected domain
                if (rowDomain === selectedDomain) {
                    row.classList.remove('domain-filtered-hidden');
                    console.log(`  ✓ SHOWING (matches ${selectedDomain})`);
                } else {
                    row.classList.add('domain-filtered-hidden');
                    console.log(`  ✗ HIDING (${rowDomain} != ${selectedDomain})`);
                }
            }
        });

        // Filter domains table using data-for-domain attribute
        const domainRows = document.querySelectorAll('#domainsTableBody tr.domain-row');
        console.log(`Total domain rows: ${domainRows.length}`);

        domainRows.forEach(function(row, idx) {
            const rowDomain = row.getAttribute('data-for-domain') || '';
            const domainCell = row.querySelector('td:first-child');
            const domainName = domainCell ? domainCell.textContent.trim() : 'unknown';

            console.log(`Domain ${idx}: domain="${domainName}", data-for-domain="${rowDomain}"`);

            // Show all if "All Domains" selected, or if it's a global whitelist
            if (selectedDomain === '' || rowDomain === 'global') {
                row.classList.remove('domain-filtered-hidden');
                console.log(`  ✓ SHOWING (${selectedDomain === '' ? 'all selected' : 'global entry'})`);
            } else {
                // Show only rows matching the selected domain
                if (rowDomain === selectedDomain) {
                    row.classList.remove('domain-filtered-hidden');
                    console.log(`  ✓ SHOWING (matches ${selectedDomain})`);
                } else {
                    row.classList.add('domain-filtered-hidden');
                    console.log(`  ✗ HIDING (${rowDomain} != ${selectedDomain})`);
                }
            }
        });

        // Update visible counts
        const visibleSenders = Array.from(senderRows).filter(r => !r.classList.contains('domain-filtered-hidden')).length;
        const visibleDomains = Array.from(domainRows).filter(r => !r.classList.contains('domain-filtered-hidden')).length;
        console.log(`=== RESULT: ${visibleSenders} senders, ${visibleDomains} domains visible ===`);
    }

    // Apply filter when dropdown changes
    $('#domainFilter').on('change', applyDomainFilter);

    // Re-apply filter when switching tabs
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        console.log('Tab switched to:', e.target.id);
        if ($('#domainFilter').length > 0) {
            applyDomainFilter();
        }
    });

    // Apply filter on page load to respect the current domain from URL
    $(document).ready(function() {
        if ($('#domainFilter').length > 0) {
            console.log('Page loaded, applying initial filter');
            applyDomainFilter();
        }
    });

    // Edit sender whitelist
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-sender')) {
            const button = e.target.closest('.edit-sender');
            const email = button.getAttribute('data-email');
            const trust = button.getAttribute('data-trust');
            const authStr = button.getAttribute('data-auth');
            const forDomain = button.getAttribute('data-for-domain');

            // Populate modal
            $('#editSenderEmail').val(email);
            $('#editSenderEmailDisplay').val(email);
            $('#editSenderTrust').val(trust);

            // Clear and set auth checkboxes
            $('#editAuthSpf, #editAuthDkim, #editAuthDmarc').prop('checked', false);
            if (authStr) {
                const authMethods = authStr.split(',');
                authMethods.forEach(function(auth) {
                    $(`#editAuth${auth.charAt(0).toUpperCase() + auth.slice(1)}`).prop('checked', true);
                });
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editSenderModal'));
            modal.show();
        }
    });

    // Save sender edit
    $('#saveSenderEdit').click(function() {
        const email = $('#editSenderEmail').val();
        const trust = $('#editSenderTrust').val();
        const auth = [];
        if ($('#editAuthSpf').is(':checked')) auth.push('spf');
        if ($('#editAuthDkim').is(':checked')) auth.push('dkim');
        if ($('#editAuthDmarc').is(':checked')) auth.push('dmarc');

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const formData = new FormData();
        formData.append('sender_email', email);
        formData.append('trust_bonus', trust);
        auth.forEach(a => formData.append('require_auth', a));

        fetch(`/whitelist/${domain}/add_sender`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrfToken},
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.message || data.error));
            }
        })
        .catch(error => {
            alert('Error updating sender: ' + error);
        });
    });

    // Edit domain whitelist
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-domain')) {
            const button = e.target.closest('.edit-domain');
            const domainName = button.getAttribute('data-domain');
            const trust = button.getAttribute('data-trust');
            const authStr = button.getAttribute('data-auth');
            const bypassBec = button.getAttribute('data-bypass-bec') === 'true';
            const bypassTypo = button.getAttribute('data-bypass-typo') === 'true';

            // Populate modal
            $('#editDomainName').val(domainName);
            $('#editDomainNameDisplay').val(domainName);
            $('#editDomainTrust').val(trust);

            // Clear and set auth checkboxes
            $('#editDomainAuthSpf, #editDomainAuthDkim, #editDomainAuthDmarc').prop('checked', false);
            if (authStr) {
                const authMethods = authStr.split(',');
                authMethods.forEach(function(auth) {
                    $(`#editDomainAuth${auth.charAt(0).toUpperCase() + auth.slice(1)}`).prop('checked', true);
                });
            }

            // Set bypass checkboxes
            $('#editDomainBypassBec').prop('checked', bypassBec);
            $('#editDomainBypassTypo').prop('checked', bypassTypo);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editDomainModal'));
            modal.show();
        }
    });

    // Save domain edit
    $('#saveDomainEdit').click(function() {
        const domainName = $('#editDomainName').val();
        const trust = $('#editDomainTrust').val();
        const auth = [];
        if ($('#editDomainAuthSpf').is(':checked')) auth.push('spf');
        if ($('#editDomainAuthDkim').is(':checked')) auth.push('dkim');
        if ($('#editDomainAuthDmarc').is(':checked')) auth.push('dmarc');
        const bypassBec = $('#editDomainBypassBec').is(':checked');
        const bypassTypo = $('#editDomainBypassTypo').is(':checked');

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const formData = new FormData();
        formData.append('target_domain', domainName);
        formData.append('trust_level', trust);
        auth.forEach(a => formData.append('require_auth', a));
        formData.append('bypass_checks', bypassBec || bypassTypo);

        fetch(`/whitelist/${domain}/add_domain`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrfToken},
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.message || data.error));
            }
        })
        .catch(error => {
            alert('Error updating domain: ' + error);
        });
    });

    // Remove sender from whitelist
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-sender')) {
            const button = e.target.closest('.remove-sender');
            const email = button.getAttribute('data-email');
            if (confirm(`Remove ${email} from whitelist?`)) {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const formData = new FormData();
                formData.append('sender_email', email);

                fetch(`/whitelist/${domain}/remove_sender`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + (data.message || data.error));
                    }
                })
                .catch(error => {
                    alert('Error removing sender: ' + error);
                });
            }
        }
    });

    // Remove domain from whitelist
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-domain')) {
            const button = e.target.closest('.remove-domain');
            const domainToRemove = button.getAttribute('data-domain');
            const forDomain = button.getAttribute('data-for-domain');
            if (confirm(`Remove ${domainToRemove} from whitelist?`)) {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const formData = new FormData();
                formData.append('whitelist_domain', domainToRemove);
                if (forDomain) {
                    formData.append('for_domain', forDomain);
                }

                fetch(`/whitelist/${domain}/remove_domain`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + (data.message || data.error));
                    }
                })
                .catch(error => {
                    alert('Error removing domain: ' + error);
                });
            }
        }
    });

    // Search for sender
    $('#searchForm').submit(function(e) {
        e.preventDefault();
        const email = $('#searchEmail').val();
        const days = $('#searchDays').val();

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const formData = new FormData();
        formData.append('sender_email', email);
        formData.append('days', days);

        fetch(`/whitelist/${domain}/search_sender`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(response => {
            if (response.success) {
                $('#searchResults').show();
                const tbody = $('#searchResultsBody');
                tbody.empty();

                if (response.results.length > 0) {
                    response.results.forEach(function(emailData) {
                        const scoreClass = emailData.spam_score >= 10 ? 'text-danger' :
                                          emailData.spam_score >= 6 ? 'text-warning' : 'text-success';

                        tbody.append(`
                            <tr>
                                <td>${emailData.timestamp}</td>
                                <td>${emailData.subject || 'N/A'}</td>
                                <td class="${scoreClass}">${emailData.spam_score}</td>
                                <td>${emailData.final_verdict || 'N/A'}</td>
                            </tr>
                        `);
                    });

                    // Show add button if not already whitelisted
                    const isWhitelisted = allSenders.some(s => s.email.toLowerCase() === email.toLowerCase());
                    if (!isWhitelisted) {
                        $('#addSearchedSender').data('email', email).show();
                    } else {
                        $('#addSearchedSender').hide();
                    }
                } else {
                    tbody.append('<tr><td colspan="4">No emails found from this sender</td></tr>');
                    $('#addSearchedSender').hide();
                }
            } else {
                alert('Error: ' + response.error);
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('Error searching: ' + error);
        });
    });

    // Add searched sender to whitelist
    $('#addSearchedSender').click(function() {
        const email = $(this).data('email');
        $('#addEmail').val(email);
        $('button[data-bs-target="#add"]').click();
    });

    // Add sender to whitelist
    $('#addSenderForm').submit(function(e) {
        e.preventDefault();
        const email = $('#addEmail').val();
        const forDomain = $('#addForDomain').val();
        const trustBonus = $('#addTrustBonus').val();
        const requireAuth = [];

        if ($('#authSpf').is(':checked')) requireAuth.push('spf');
        if ($('#authDkim').is(':checked')) requireAuth.push('dkim');
        if ($('#authDmarc').is(':checked')) requireAuth.push('dmarc');

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const formData = new FormData();
        formData.append('sender_email', email);
        formData.append('trust_bonus', trustBonus);
        formData.append('for_domain', forDomain || domain);
        requireAuth.forEach(auth => formData.append('require_auth', auth));

        fetch(`/whitelist/${forDomain || domain}/add_sender`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(response => {
            if (response.success) {
                alert(response.message);
                location.reload();
            } else {
                alert('Error: ' + (response.message || response.error));
            }
        })
        .catch(error => {
            console.error('Add sender error:', error);
            alert('Error adding sender: ' + error);
        });
    });

    // Add domain to whitelist (admin only)
    $('#addDomainForm').submit(function(e) {
        e.preventDefault();
        const targetDomain = $('#addDomain').val();
        const trustLevel = $('#domainTrustLevel').val();
        const bypassChecks = $('#bypassChecks').is(':checked');

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const formData = new FormData();
        formData.append('target_domain', targetDomain);
        formData.append('trust_level', trustLevel);
        formData.append('bypass_checks', bypassChecks);
        formData.append('require_auth', 'spf');

        fetch(`/whitelist/${domain}/add_domain`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Add domain error:', error);
            alert('Error adding domain: ' + error);
        });
    });
});
</script>
{% endblock %}