================================================================================
ClickSend SMS Notification Setup Guide
OpenEFA Email Filter - Backend Notification System
================================================================================

OVERVIEW
--------
This backend notification system sends SMS alerts via ClickSend API for:
  - High-risk email detection (phishing, BEC, viruses, high spam scores)
  - System alerts (critical errors, service failures)
  - Daily summary reports (email statistics)

The system is fully configurable and includes rate limiting to prevent spam.


PREREQUISITES
-------------
1. Active ClickSend account (sign up at https://www.clicksend.com)
2. ClickSend API credentials (username and API key)
3. Sufficient SMS credits in your ClickSend account


SETUP INSTRUCTIONS
------------------

Step 1: Get ClickSend API Credentials
--------------------------------------
  1. Log in to your ClickSend account at https://dashboard.clicksend.com
  2. Navigate to: Developers & API > API Credentials
  3. Copy your API Username
  4. Generate or copy your API Key
  5. Note your sender number/name (optional)


Step 2: Configure Notification Settings
---------------------------------------
  Edit the configuration file:
    /opt/spacyserver/config/notification_config.json

  Update the following fields:

  "clicksend": {
    "enabled": true,                           ← Change to true to enable
    "username": "YOUR_CLICKSEND_USERNAME",     ← Your ClickSend username
    "api_key": "YOUR_CLICKSEND_API_KEY",       ← Your ClickSend API key
    "from_number": "YOUR_SENDER_NUMBER_OR_NAME"← Optional sender ID
  }


Step 3: Configure Notification Recipients
-----------------------------------------
  In the same config file, update recipient phone numbers:

  "notification_settings": {
    "high_risk_alerts": {
      "enabled": true,                         ← Enable/disable high-risk alerts
      "spam_score_threshold": 80,              ← Score threshold to trigger alert
      "recipients": [
        "+12345678901",                        ← Replace with your phone number(s)
        "+12345678902"                         ← Add multiple recipients if needed
      ],
      "triggers": {
        "phishing_detected": true,             ← Enable/disable specific triggers
        "bec_detected": true,
        "virus_detected": true,
        "high_spam_score": true
      }
    },
    "system_alerts": {
      "enabled": true,                         ← Enable/disable system alerts
      "recipients": [
        "+12345678901"
      ]
    },
    "daily_summary": {
      "enabled": true,                         ← Enable/disable daily summaries
      "recipients": [
        "+12345678901"
      ],
      "send_time": "08:00",                    ← Time to send daily report
      "timezone": "America/New_York"           ← Your timezone
    }
  }

  Note: Phone numbers MUST include country code (e.g., +1 for US)


Step 4: Test the Connection
---------------------------
  Test your ClickSend credentials:

    /opt/spacyserver/notification_service.py test

  Expected output:
    Connection test: SUCCESS
    Message: Connection successful

  If you see an error, verify your credentials in the config file.


Step 5: Send Test Notification
-------------------------------
  Send a test alert to verify SMS delivery:

    /opt/spacyserver/notification_service.py alert "Test notification from OpenEFA"

  You should receive an SMS within a few seconds.


Step 6: Setup Daily Summary (Optional)
--------------------------------------
  To receive daily email statistics via SMS, add a cron job:

    sudo crontab -e

  Add this line to run daily at 8 AM:

    0 8 * * * /opt/spacyserver/venv/bin/python3 /opt/spacyserver/scripts/send_daily_notification_summary.py >> /opt/spacyserver/logs/daily_summary.log 2>&1

  Or manually test the daily summary:

    /opt/spacyserver/scripts/send_daily_notification_summary.py


CONFIGURATION OPTIONS
---------------------

Rate Limiting Settings:
  "rate_limiting": {
    "max_notifications_per_hour": 10,         ← Max SMS per hour per recipient
    "cooldown_minutes": 5,                    ← Min time between notifications
    "duplicate_suppression_minutes": 30       ← Suppress duplicate alerts
  }

Message Templates:
  Customize notification messages in the "message_templates" section:
  - {sender}, {score}, {reason} are replaced with actual values
  - Keep messages under 160 characters for single SMS
  - Longer messages will use multiple SMS credits


MONITORING & LOGS
-----------------

View notification logs:
  /opt/spacyserver/logs/notifications.log

Check notification history in database:
  mysql -u root -p spacy_email_db
  SELECT * FROM notification_log ORDER BY created_at DESC LIMIT 20;

View rate limiting status:
  SELECT * FROM notification_rate_limit;


TROUBLESHOOTING
---------------

Problem: "ClickSend client not initialized"
Solution:
  - Verify credentials in /opt/spacyserver/config/notification_config.json
  - Ensure "enabled" is set to true
  - Check credentials are not the placeholder values

Problem: "API Error: Unauthorized"
Solution:
  - Verify API credentials are correct
  - Check your ClickSend account is active
  - Regenerate API key if needed

Problem: "SMS not received"
Solution:
  - Verify phone number includes country code (+1, etc.)
  - Check ClickSend account has sufficient credits
  - Check SMS delivery status in ClickSend dashboard
  - Verify rate limits haven't been exceeded

Problem: "Rate limit exceeded"
Solution:
  - Adjust rate_limiting settings in config
  - Check notification_rate_limit table in database
  - Wait for cooldown period to expire


COST MANAGEMENT
---------------

- Each SMS uses 1 credit (160 characters)
- Longer messages use multiple credits
- Monitor credit usage in ClickSend dashboard
- Set "max_notifications_per_hour" to control costs
- Disable non-critical notifications if needed


SECURITY NOTES
--------------

- Config file has 600 permissions (only root/spacy-filter can read)
- API credentials are never logged
- Keep your API key secure
- Regularly rotate API keys for security
- Monitor notification logs for unusual activity


UNINSTALLING
------------

To disable notifications without removing code:
  1. Edit /opt/spacyserver/config/notification_config.json
  2. Set "enabled": false under "clicksend" section

To completely remove:
  1. Remove notification_service.py import from email_filter.py
  2. Remove notification triggers from email_filter.py
  3. Remove cron jobs
  4. Optional: DROP TABLE notification_log; DROP TABLE notification_rate_limit;


SUPPORT
-------

ClickSend Documentation: https://developers.clicksend.com/docs/rest/v3/
ClickSend Support: https://www.clicksend.com/help

For OpenEFA issues, check the main documentation or logs.


================================================================================
